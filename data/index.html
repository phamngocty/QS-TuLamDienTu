<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1"
    />
    <title>ESP32-C3 Quickshifter</title>

    <style>
      :root {
        --bg: #0B0F1A;
        --surface1: #0F1526;
        --card: #151B2E;
        --border: #26304B;
        --text: #EAF2FF;
        --sub: #9BB0D3;
        --primary: #2D7DFF;
        --highlight: #FFD100;
        --danger: #FF6B6B;
        --success: #22C55E;
        --warning: #FFC107;
        --br: 16px;
        --pad: 16px;
        --gap: 12px;
        --shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        background: linear-gradient(180deg, var(--bg), var(--surface1));
        color: var(--text);
        font-family: system-ui, Segoe UI, Roboto, Arial, sans-serif;
      }
      header {
        position: sticky;
        top: 0;
        z-index: 5;
        background: linear-gradient(90deg, var(--bg), var(--surface1));
        padding: 14px 16px;
        display: flex;
        align-items: center;
        gap: 10px;
        border-bottom: 1px solid var(--border);
        box-shadow: var(--shadow);
      }
      header .dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: var(--highlight);
        box-shadow: 0 0 12px var(--highlight);
      }
      header h1 {
        font-size: 18px;
        margin: 0;
        font-weight: 700;
        letter-spacing: 0.3px;
      }
      header .sp {
        flex: 1;
      }
             header .btn-danger {
         background: var(--danger);
         border: none;
         color: #fff;
         padding: 8px 12px;
         border-radius: 10px;
         cursor: pointer;
       }
       
       /* Status Indicators */
       .status-indicators {
         display: flex;
         gap: 16px;
         align-items: center;
         margin-right: 16px;
       }
       
       .status-item {
         display: flex;
         align-items: center;
         gap: 6px;
         padding: 6px 12px;
         background: var(--card);
         border: 1px solid var(--border);
         border-radius: 8px;
         font-size: 12px;
         min-width: 80px;
         justify-content: center;
       }
       
       .status-label {
         color: var(--sub);
         font-weight: 500;
       }
       
       .status-value {
         color: var(--text);
         font-weight: 600;
       }
       
       #wifiStatus .status-value {
         color: var(--success);
       }
       
       #lockStatus .status-value {
         color: var(--warning);
       }
       
       #rpmStatus .status-value {
         color: var(--highlight);
       }
      main {
        padding: 16px;
        display: grid;
        gap: var(--gap);
        grid-template-columns: 1fr;
      }
      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--br);
        padding: var(--pad);
        box-shadow: var(--shadow);
      }
      .tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 8px;
      }
      .tab-btn {
        border: 1px solid var(--border);
        background: var(--surface1);
        color: var(--text);
        padding: 8px 12px;
        border-radius: 10px;
        cursor: pointer;
      }
      .tab-btn.active {
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(45, 125, 255, 0.25);
      }
      .row {
        display: grid;
        gap: var(--gap);
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }
      label {
        display: flex;
        flex-direction: column;
        gap: 6px;
        font-size: 13px;
        color: var(--sub);
      }
      input,
      select {
        background: var(--surface1);
        color: var(--text);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 8px 10px;
        outline: none;
      }
      input:focus,
      select:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(45, 125, 255, 0.25);
      }
      .btn {
        border: 1px solid var(--border);
        background: var(--surface1);
        color: var(--text);
        padding: 8px 12px;
        border-radius: 10px;
        cursor: pointer;
      }
      .btn.primary {
        border-color: var(--primary);
        background: var(--primary);
        color: var(--text);
      }
      .btn.accent {
        border-color: var(--highlight);
        background: var(--highlight);
        color: var(--bg);
      }
      .btn.ok {
        border-color: var(--success);
        background: var(--success);
        color: var(--text);
      }
      .btn.danger {
        border-color: var(--danger);
        background: var(--danger);
        color: var(--text);
      }
      .table {
        overflow: auto;
        border-radius: 12px;
        border: 1px solid var(--border);
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }
      th,
      td {
        padding: 8px 10px;
        border-bottom: 1px solid var(--border);
        text-align: left;
      }
      pre {
        white-space: pre-wrap;
        background: var(--surface1);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 10px;
        max-height: 260px;
        overflow: auto;
      }
      .muted {
        color: var(--sub);
      }
      .progress {
        height: 8px;
        background: var(--surface1);
        border-radius: 4px;
        margin: 8px 0;
        border: 1px solid var(--border);
      }
      .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, var(--primary), var(--success));
        border-radius: 4px;
        transition: width 0.3s ease;
      }
      @media (min-width: 900px) {
        main {
          grid-template-columns: 1fr 1fr;
        }
      }
    </style>
  </head>

  <body>
         <!-- ====================== HEADER ====================== -->
     <header>
       <div class="dot"></div>
       <h1>Tự làm điện tử — Quickshifter</h1>
       <div class="sp"></div>
       
       <!-- Status Indicators -->
       <div class="status-indicators">
         <div class="status-item" id="wifiStatus">
           <span class="status-label">WiFi:</span>
           <span class="status-value" id="wifiStatusText">Connecting...</span>
         </div>
         <div class="status-item" id="lockStatus">
           <span class="status-label">Lock:</span>
           <span class="status-value" id="lockStatusText">Unknown</span>
         </div>
         <div class="status-item" id="rpmStatus">
           <span class="status-label">RPM:</span>
           <span class="status-value" id="rpmStatusText">0</span>
         </div>
       </div>
       
       <button id="btnWifiOff" class="btn-danger">Tắt Wi-Fi</button>
     </header>

    <!-- ======================= BODY ======================= -->
    <main>
      <div class="card">
        <!-- -------- Tabs -------- -->
                 <div class="tabs">
           <button id="t_qs" class="tab-btn active">Quickshifter</button>
           <button id="t_bf" class="tab-btn">Backfire</button>
           <button id="t_tools" class="tab-btn">Tools & Logs</button>
           <button id="t_lock" class="tab-btn">Lock</button>
           <button id="t_wifi" class="tab-btn">WiFi</button>
           <button id="t_ota" class="tab-btn">OTA</button>
         </div>

        <!-- ========== TAB: QUICKSHIFTER ========== -->
        <section id="qs">
          <!-- Controls -->
          <div class="row">
            <label>
              Mode
              <select id="mode">
                <option value="0">Manual</option>
                <option value="1">Auto</option>
              </select>
            </label>

            <label>
              Cut Output
              <select id="cutout">
                <option value="0">Ignition</option>
                <option value="1">Injector</option>
              </select>
            </label>

            <label>
              RPM Source
              <select id="rsrc">
                <option value="0">Coil</option>
                <option value="1">Injector</option>
              </select>
            </label>

            <label>
              PPR
              <select id="ppr">
                <option>0.5</option>
                <option selected>1</option>
                <option>2</option>
              </select>
            </label>

            <label>RPM min <input id="rpmmin" type="number" value="2500" /></label>
            <label>Manual kill (ms) <input id="mkill" type="number" value="70" /></label>
            <label>Debounce shift (ms) <input id="deb" type="number" value="15" /></label>
            <label>Hold-off (ms) <input id="hold" type="number" value="200" /></label>
          </div>

          <div style="margin-top: 8px">
            <button id="btnSaveQS" class="btn ok">Lưu Quickshifter</button>
            <span id="msgQuickshifter" class="muted" style="margin-left: 8px;"></span>
          </div>

          <!-- Live RPM Gauge -->
          <div id="rpmCard" class="card" style="margin-top: 10px">
            <h3>Live RPM</h3>

            <div class="rpm-wrap" style="display: grid; place-items: center; padding: 10px">
  <svg
    id="rpmGauge"
    viewBox="0 0 240 240"
    width="100%"
    style="max-width: 420px"
  >
<!-- track (8h → 3h, cung dài 210°) -->
<path
  id="trackPath"
  fill="none"
  stroke="#24323B"
  stroke-width="16"
  stroke-linecap="round"
  d="M 42.060 165.000 A 90 90 0 1 1 210.000 120.000"
/>
<g id="rpmTicks" stroke="#2A3238"></g>

<!-- value arc (8h → 3h) -->
<path
  id="rpmArc"
  fill="none"
  stroke="#1E88FF"
  stroke-width="16"
  stroke-linecap="round"
  stroke-dasharray="0 999"
  d="M 42.060 165.000 A 90 90 0 1 1 210.000 120.000"
/>



    <!-- kim -->
    <line
      id="rpmNeedle"
      x1="120"
      y1="120"
      x2="120"
      y2="35"
      stroke="#FFEB3B"
      stroke-width="4"
      stroke-linecap="round"
      
          
    ></line>

    <!-- tâm kim -->
    <circle cx="120" cy="120" r="6" fill="#FFEB3B"></circle>

    <!-- nhãn RPM -->
    <text
      id="rpmValue"
      x="120"
      y="200"
      text-anchor="middle"
      fill="#fff"
      font-size="20"
      font-weight="bold"
    >0 rpm</text>
  </svg>
</div>


              <div style="margin-top: 6px; font-size: 28px; font-weight: 700">
                <span id="rpmText">0</span>
                <span style="font-size: 14px; color: #a6b3bd">rpm</span>
              </div>
            </div>
          </div>

          
<!-- Auto Map -->
          <div class="card" style="margin-top: 10px">
            <h3>Auto Map</h3>
            <div class="table">
              <table>
                <thead>
                  <tr>
                    <th>Lo</th>
                    <th>Hi</th>
                    <th>Cut (ms)</th>
                  </tr>
                </thead>
                <tbody id="map"></tbody>
              </table>
            </div>

            <div style="display: flex; gap: 8px; margin-top: 8px">
              <button id="btnAddRow" class="btn accent">Thêm dòng</button>
              <button id="btnSave" class="btn ok">Lưu</button>
              <button id="btnLoad" class="btn">Tải</button>
            </div>
            <div id="msgAutoMap" class="muted" style="margin-top: 4px;"></div>
          </div>
        </section>

        <!-- ========== TAB: BACKFIRE ========== -->
        <section id="bf" style="display:none">
  <div class="row">
    <label><span>Enable</span><input id="bf_enable" type="checkbox" /></label>
    <label><span>IGN only</span><input id="bf_ign_only" type="checkbox" checked /></label>

    <label>Mode
      <div style="display:flex; gap:12px; align-items:center">
        <label><input id="bf_mode_shift"   type="checkbox" checked /> SHIFT</label>
        <label><input id="bf_mode_overrun" type="checkbox" checked /> OVERRUN</label>
      </div>
    </label>

    <label>RPM min <input id="bf_rpm_min" type="number" value="4500" /></label>
    <label>RPM max <input id="bf_rpm_max" type="number" value="9000" /></label>
    <label>Warmup (s) <input id="bf_warmup_s" type="number" value="120" /></label>

    <label>Decel threshold (rpm/s)
      <input id="bf_decel_thresh" type="number" value="3000" />
    </label>
    <label>Window after shift (ms)
      <input id="bf_window_ms" type="number" value="250" />
    </label>

    <label>Burst count <input id="bf_burst_count" type="number" value="3" /></label>
    <label>Burst ON (ms) <input id="bf_burst_on" type="number" value="25" /></label>
    <label>Burst OFF (ms) <input id="bf_burst_off" type="number" value="75" /></label>
    <label>Refractory (ms) <input id="bf_refractory_ms" type="number" value="1500" /></label>
  </div>

  <div style="margin-top:8px">
    <button id="btnSaveBF" class="btn ok">Lưu</button>
    <span id="msgBackfire" class="muted" style="margin-left: 8px;"></span>
  </div>
</section>


        <!-- ========== TAB: TOOLS & LOGS ========== -->
        <section id="tools" style="display: none">
          <div class="row">
            <div class="card">
              <h3>Test Output</h3>
              <div style="display: flex; gap: 8px; flex-wrap: wrap">
                <button id="btnTestIgn" class="btn primary">Cắt IGN 50ms</button>
                <button id="btnTestInj" class="btn primary">Cắt INJ 50ms</button>
              </div>
            </div>

            <div class="card">
              <h3>Test RPM</h3>
              <div class="row">
                <label>Enable <input id="tr_en" type="checkbox" /></label>
                <label>RPM <input id="tr_rpm" type="number" value="5000" /></label>
                <label>
                  PPR
                  <select id="tr_ppr">
                    <option>0.5</option>
                    <option selected>1</option>
                    <option>2</option>
                  </select>
                </label>
              </div>

              <div style="margin-top: 8px">
                <button id="btnApplyTR" class="btn ok">Apply</button>
              </div>
            </div>

            <div class="card">
              <h3>Calibrate RPM</h3>
              <div class="row">
                <label>RPM thực tế <input id="cal_true" type="number" /></label>
              </div>

              <div style="margin-top: 8px">
                <button id="btnCalib" class="btn ok">Calibrate</button>
              </div>
            </div>

            <div class="card">
              <h3>Config</h3>
              <div style="display: flex; gap: 8px; flex-wrap: wrap">
                <button id="btnExport" class="btn">Export JSON</button>
                <input id="f" class="btn" type="file" accept=".json" />
                <button id="btnReload" class="btn">Reload</button>
                <button id="btnSaveAll" class="btn ok">Save All</button>
              </div>
              <div id="msgTools" class="muted" style="margin-top: 4px;"></div>
            </div>
          </div>

          <div class="card">
            <h3>Logs</h3>
            <pre id="logs" class="muted"></pre>
            <div>
              <button id="btnClearLog" class="btn danger">Clear</button>
            </div>
          </div>
        </section>

        <!-- ========== TAB: LOCK ========== -->
        <section id="lock" style="display: none">
          <div class="row">
            <div class="card">
              <h3>Vehicle Lock</h3>
              <div class="row" style="align-items:center">
                <span class="muted">•</span>
                <span id="lockStateText" class="muted">Unknown</span>
                <button id="btnLockRefresh" class="btn" style="margin-left:auto">Refresh</button>
              </div>
            </div>

            <div class="card">
              <h3>Cấu hình</h3>
              <div class="row">
                <label><span>Enable Lock khi cấp nguồn</span><input id="lock_enabled" type="checkbox" /></label>
                <label>Cut on lock
                  <select id="lock_cut_sel">
                    <option value="ign">Ignition</option>
                    <option value="inj">Injector</option>
                  </select>
                </label>
                <label>Short max (ms) <input id="lock_short_ms_max" type="number" value="300" /></label>
                <label>Long min (ms)  <input id="lock_long_ms_min"  type="number" value="600" /></label>
                <label>Gap (ms)       <input id="lock_gap_ms"       type="number" value="400" /></label>
                <label>Timeout (s)    <input id="lock_timeout_s"    type="number" value="30" /></label>
                <label>Max retries    <input id="lock_max_retries"  type="number" value="5" /></label>
              </div>
              <div style="margin-top:8px">
                <button id="btnLockSaveCfg" class="btn ok">Save Lock</button>
                <span id="msgLockCfg" class="muted" style="margin-left: 8px;"></span>
              </div>
            </div>

            <div class="card">
              <h3>Điều khiển</h3>
              <div class="row" style="gap:10px; align-items:center">
                <button id="btnLockNow" class="btn danger">Lock Now</button>
                <span class="muted">→ Cắt theo "Cut on lock"</span>
              </div>
              <div class="row" style="gap:10px">
                <input id="unlock_pass" placeholder="Pass 0/1 (vd: 1001)" maxlength="8" />
                <button id="btnUnlockPass" class="btn">Unlock (Pass)</button>
              </div>
              <hr>
              <h4>Set / Change Pass</h4>
              <div class="row" style="gap:10px">
                <input id="old_pass" placeholder="Current pass (0/1)" maxlength="8" />
                <input id="new_pass" placeholder="New pass (0/1)" maxlength="8" />
                <input id="new_pass2" placeholder="Repeat new pass" maxlength="8" />
              </div>
              <div class="row">
                <button id="btnLockSet" class="btn">Set Pass</button>
                <button id="btnLockChange" class="btn">Change Pass</button>
                <span id="msgLockPass" class="muted"></span>
              </div>
            </div>
          </div>
        </section>

                 <!-- ========== TAB: WIFI ========== -->
         <section id="wifi" style="display: none">
           <div class="row">
             <div class="card">
               <h3>WiFi Configuration</h3>
               <div class="row">
                 <label>AP SSID <input id="ap_ssid" type="text" placeholder="Quickshifter_AP" /></label>
                 <label>AP Password <input id="ap_pass" type="password" placeholder="12345678" /></label>
                 <label>AP Timeout (s) <input id="ap_timeout_s" type="number" value="300" /></label>
               </div>
               <div style="margin-top: 8px">
                 <button id="btnWifiSave" class="btn ok">Save WiFi Config</button>
                 <span id="msgWifi" class="muted" style="margin-left: 8px;"></span>
               </div>
             </div>

             <div class="card">
               <h3>WiFi Status</h3>
               <div class="row" style="align-items: center">
                 <span class="muted">•</span>
                 <span id="wifiStatusText" class="muted">Checking...</span>
                 <button id="btnWifiRefresh" class="btn" style="margin-left: auto">Refresh</button>
               </div>
               <div style="margin-top: 8px">
                 <button id="btnWifiHold" class="btn primary">Hold WiFi ON</button>
                 <button id="btnWifiOff" class="btn danger">Turn OFF WiFi</button>
               </div>
             </div>
           </div>
         </section>

         <!-- ========== TAB: OTA ========== -->
         <section id="ota" style="display: none">
          <div class="row">
            <div class="card">
              <h3>Firmware Update</h3>
              <div style="display: flex; gap: 8px; flex-wrap: wrap">
                <input id="firmwareFile" type="file" accept=".bin" />
                <button id="btnUploadFw" class="btn primary">Upload Firmware</button>
              </div>
              <div id="fwProgress" style="display: none; margin-top: 8px;">
                <div class="progress">
                  <div class="progress-bar" style="width: 0%"></div>
                </div>
                <div id="fwStatus" class="muted" style="margin-top: 4px;"></div>
              </div>
            </div>

            <div class="card">
              <h3>Filesystem Update</h3>
              <div style="display: flex; gap: 8px; flex-wrap: wrap">
                <input id="fsFile" type="file" accept=".bin" />
                <button id="btnUploadFs" class="btn primary">Upload FS Image</button>
              </div>
              <div id="fsProgress" style="display: none; margin-top: 8px;">
                <div class="progress">
                  <div class="progress-bar" style="width: 0%"></div>
                </div>
                <div id="fsStatus" class="muted" style="margin-top: 4px;"></div>
              </div>
            </div>

            <div class="card">
              <h3>Single File Upload</h3>
              <div style="display: flex; gap: 8px; flex-wrap: wrap">
                <input id="singleFile" type="file" />
                <input id="filePath" placeholder="Path (e.g. /index.html)" />
                <button id="btnUploadSingle" class="btn accent">Upload File</button>
              </div>
              <div id="singleStatus" class="muted" style="margin-top: 4px;"></div>
            </div>
          </div>

          <div class="card">
            <h3>OTA Management</h3>
            <div class="row" style="gap: 8px; flex-wrap: wrap">
              <button id="btnOtaState" class="btn">Check Status</button>
              <button id="btnBackupFs" class="btn">Backup FS</button>
              <button id="btnRollbackFs" class="btn danger">Rollback FS</button>
              <button id="btnRollbackFw" class="btn danger">Rollback FW</button>
            </div>
            <div id="otaStatus" class="muted" style="margin-top: 8px;"></div>
          </div>
        </section>

      </div>
    </main>

    <!-- ===================== SCRIPTS ===================== -->
    <script>
      /* ---------- Helpers + Tabs ---------- */
      const q = (s) => document.querySelector(s);
      const qa = (s) => [...document.querySelectorAll(s)];

             const tabs = { qs: q("#qs"), bf: q("#bf"), tools: q("#tools"), lock: q("#lock"), wifi: q("#wifi"), ota: q("#ota") };
       const tb = { qs: q("#t_qs"), bf: q("#t_bf"), tools: q("#t_tools"), lock: q("#t_lock"), wifi: q("#t_wifi"), ota: q("#t_ota") };

      function setTab(id) {
        for (const k in tabs) {
          tabs[k].style.display = k === id ? "block" : "none";
          tb[k].classList.toggle("active", k === id);
        }
      }
             tb.qs.onclick = () => setTab("qs");
       tb.bf.onclick = () => setTab("bf");
       tb.tools.onclick = () => setTab("tools");
       tb.lock.onclick  = () => setTab("lock");
       tb.wifi.onclick  = () => setTab("wifi");
       tb.ota.onclick  = () => setTab("ota");

      async function apiGet(p) {
        const r = await fetch(p);
        return r.ok ? r.json() : null;
      }
      async function apiText(p, o) {
        const r = await fetch(p, o);
        return r.text();
      }

             async function hold() {
         try {
           await apiText("/api/wifi_hold?on=1", { method: "POST" });
           // Cập nhật WiFi status
           updateWifiStatus("Connected");
         } catch (e) {
           updateWifiStatus("Error");
         }
       }
       
       function updateWifiStatus(status) {
         const wifiStatusText = q("#wifiStatusText");
         if (wifiStatusText) {
           wifiStatusText.textContent = status;
           // Thay đổi màu theo trạng thái
           const wifiStatus = q("#wifiStatus");
           if (wifiStatus) {
             wifiStatus.style.borderColor = status === "Connected" ? "var(--success)" : "var(--danger)";
           }
         }
       }
      async function wifiOff() {
        if (confirm("Tắt Wi-Fi AP ngay?")) {
          await apiText("/api/wifi_off", { method: "POST" });
        }
      }
             q("#btnWifiOff").onclick = wifiOff;
       
       // WiFi Save function
       async function saveWifiConfig() {
         try {
           const wifiConfig = {
             ap_ssid: q("#ap_ssid")?.value || "Quickshifter_AP",
             ap_pass: q("#ap_pass")?.value || "12345678",
             ap_timeout_s: +q("#ap_timeout_s")?.value || 300
           };
           
           const result = await apiText("/api/set", { 
             method: "POST", 
             body: JSON.stringify(wifiConfig) 
           });
           
           // Hiển thị feedback
           const msgWifi = q("#msgWifi");
           if (msgWifi) {
             msgWifi.textContent = "WiFi config saved successfully!";
             msgWifi.style.color = "var(--success)";
             setTimeout(() => {
               msgWifi.textContent = "";
               msgWifi.style.color = "";
             }, 3000);
           }
           
           // Cập nhật status
           updateWifiStatus("Config Updated");
           
         } catch (e) {
           const msgWifi = q("#msgWifi");
           if (msgWifi) {
             msgWifi.textContent = "Error saving WiFi config: " + e.message;
             msgWifi.style.color = "var(--danger)";
             setTimeout(() => {
               msgWifi.textContent = "";
               msgWifi.style.color = "";
             }, 3000);
           }
         }
       }
       
       // WiFi status refresh
       async function refreshWifiStatus() {
         try {
           const response = await fetch("/api/wifi_status");
           if (response.ok) {
             const status = await response.json();
             updateWifiStatus(status.connected ? "Connected" : "Disconnected");
           } else {
             updateWifiStatus("Unknown");
           }
         } catch (e) {
           updateWifiStatus("Error");
         }
       }

      /* ---------- Config load/save ---------- */
      let cfg = {};

      function renderCfg() {
        q("#mode").value = cfg.mode;
        q("#cutout").value = cfg.cut_output;
        q("#rsrc").value = cfg.rpm_source;
        q("#ppr").value = cfg.ppr;
        q("#rpmmin").value = cfg.rpm_min;
        q("#mkill").value = cfg.manual_kill_ms;
        q("#deb").value = cfg.debounce_shift_ms;
        q("#hold").value = cfg.holdoff_ms;

        q("#bf_en").checked = cfg.backfire_enabled;
        q("#bf_ex").value = cfg.backfire_extra_ms;
        q("#bf_min").value = cfg.backfire_min_rpm;
        // --- Backfire ---
q("#bf_enable").checked      = !!cfg.bf_enable;
q("#bf_ign_only").checked    = cfg.bf_ign_only ?? true;

q("#bf_mode_shift").checked   = (cfg.bf_mode ?? 3) & 0x01;
q("#bf_mode_overrun").checked = (cfg.bf_mode ?? 3) & 0x02;

q("#bf_rpm_min").value      = cfg.bf_rpm_min ?? 4500;
q("#bf_rpm_max").value      = cfg.bf_rpm_max ?? 9000;
q("#bf_warmup_s").value     = cfg.bf_warmup_s ?? 120;

q("#bf_decel_thresh").value = cfg.bf_decel_thresh ?? 3000;
q("#bf_window_ms").value    = cfg.bf_window_ms ?? 250;

q("#bf_burst_count").value  = cfg.bf_burst_count ?? 3;
q("#bf_burst_on").value     = cfg.bf_burst_on ?? 25;
q("#bf_burst_off").value    = cfg.bf_burst_off ?? 75;
         q("#bf_refractory_ms").value= cfg.bf_refractory_ms ?? 1500;
         q("#btnSaveBF").onclick = save;

         // --- Lock ---
         q("#lock_enabled").checked = cfg.lock_enabled || false;
         q("#lock_cut_sel").value = cfg.lock_cut_sel || "ign";
         q("#lock_short_ms_max").value = cfg.lock_short_ms_max || 300;
         q("#lock_long_ms_min").value = cfg.lock_long_ms_min || 600;
         q("#lock_gap_ms").value = cfg.lock_gap_ms || 400;
         q("#lock_timeout_s").value = cfg.lock_timeout_s || 30;
         q("#lock_max_retries").value = cfg.lock_max_retries || 5;

         // --- WiFi ---
         q("#ap_ssid").value = cfg.ap_ssid ?? "Quickshifter_AP";
         q("#ap_pass").value = cfg.ap_pass ?? "12345678";
         q("#ap_timeout_s").value = cfg.ap_timeout_s ?? 300;


        cfg.map = [];
        document.querySelectorAll("#map tr").forEach((tr) => {
          const t = tr.querySelectorAll("input");
          cfg.map.push({ lo: +t[0].value, hi: +t[1].value, t: +t[2].value });
        });
      }

      function collectCfg() {
        cfg.mode = +q("#mode").value;
        cfg.cut_output = +q("#cutout").value;
        cfg.rpm_source = +q("#rsrc").value;
        cfg.ppr = parseFloat(q("#ppr").value);
        cfg.rpm_min = +q("#rpmmin").value;
        cfg.manual_kill_ms = +q("#mkill").value;
        cfg.debounce_shift_ms = +q("#deb").value;
        cfg.holdoff_ms = +q("#hold").value;

        cfg.backfire_enabled = q("#bf_en").checked;
        cfg.backfire_extra_ms = +q("#bf_ex").value;
        cfg.backfire_min_rpm = +q("#bf_min").value;
        // --- Backfire ---
let mode = 0;
if (q("#bf_mode_shift").checked)   mode |= 0x01;   // BF_SHIFT
if (q("#bf_mode_overrun").checked) mode |= 0x02;   // BF_OVERRUN

cfg.bf_enable        = q("#bf_enable").checked ? 1 : 0;
cfg.bf_ign_only      = q("#bf_ign_only").checked ? 1 : 0;
cfg.bf_mode          = mode;

cfg.bf_rpm_min       = +q("#bf_rpm_min").value;
cfg.bf_rpm_max       = +q("#bf_rpm_max").value;
cfg.bf_warmup_s      = +q("#bf_warmup_s").value;

cfg.bf_decel_thresh  = +q("#bf_decel_thresh").value;
cfg.bf_window_ms     = +q("#bf_window_ms").value;

cfg.bf_burst_count   = +q("#bf_burst_count").value;
cfg.bf_burst_on      = +q("#bf_burst_on").value;
cfg.bf_burst_off     = +q("#bf_burst_off").value;
                 cfg.bf_refractory_ms = +q("#bf_refractory_ms").value;
         // q("#btnSaveBF").onclick = save; // Đã được gán ở dưới

         // --- Lock ---
         cfg.lock_enabled = q("#lock_enabled")?.checked || false;
         cfg.lock_cut_sel = q("#lock_cut_sel")?.value || "ign";
         cfg.lock_short_ms_max = +q("#lock_short_ms_max")?.value || 300;
         cfg.lock_long_ms_min = +q("#lock_long_ms_min")?.value || 600;
         cfg.lock_gap_ms = +q("#lock_gap_ms")?.value || 400;
         cfg.lock_timeout_s = +q("#lock_timeout_s")?.value || 30;
         cfg.lock_max_retries = +q("#lock_max_retries")?.value || 5;

         // --- WiFi ---
         cfg.ap_ssid = q("#ap_ssid")?.value || "Quickshifter_AP";
         cfg.ap_pass = q("#ap_pass")?.value || "12345678";
         cfg.ap_timeout_s = +q("#ap_timeout_s")?.value || 300;


        cfg.map = [];
        document.querySelectorAll("#map tr").forEach((tr) => {
          const t = tr.querySelectorAll("input");
          cfg.map.push({ lo: +t[0].value, hi: +t[1].value, t: +t[2].value });
        });
      }

      async function load() {
        const d = await apiGet("/api/get");
        if (d) {
          cfg = d;
          renderCfg();
        }
      }
      async function save() {
        try {
          collectCfg();
          const result = await apiText("/api/set", { method: "POST", body: JSON.stringify(cfg) });
          q("#msgQuickshifter").textContent = result;
          q("#msgTools").textContent = result;
          q("#msgAutoMap").textContent = result;
          setTimeout(() => {
            q("#msgQuickshifter").textContent = "";
            q("#msgTools").textContent = "";
            q("#msgAutoMap").textContent = "";
          }, 2000);
        } catch (e) {
          const errorMsg = "Error: " + e.message;
          q("#msgQuickshifter").textContent = errorMsg;
          q("#msgTools").textContent = errorMsg;
          q("#msgAutoMap").textContent = errorMsg;
          setTimeout(() => {
            q("#msgQuickshifter").textContent = "";
            q("#msgTools").textContent = "";
            q("#msgAutoMap").textContent = "";
          }, 2000);
        }
      }

      async function saveBackfire() {
        try {
          collectCfg();
          const result = await apiText("/api/set", { method: "POST", body: JSON.stringify(cfg) });
          q("#msgBackfire").textContent = result;
          setTimeout(() => q("#msgBackfire").textContent = "", 2000);
        } catch (e) {
          q("#msgBackfire").textContent = "Error: " + e.message;
          setTimeout(() => q("#msgBackfire").textContent = "", 2000);
        }
      }

      q("#btnAddRow").onclick = () => {
        const tr = document.createElement("tr");
        tr.innerHTML =
          '<td><input type="number"></td><td><input type="number"></td><td><input type="number"></td>';
        q("#map").appendChild(tr);
      };
      q("#btnSave").onclick = save;
      q("#btnLoad").onclick = load;
      q("#btnSaveBF").onclick = saveBackfire;
      q("#btnSaveQS").onclick = save;
      q("#btnSaveAll").onclick = save;
      q("#btnReload").onclick = load;

      q("#btnExport").onclick = () => {
        const s = JSON.stringify(cfg, null, 2);
        const a = document.createElement("a");
        a.href = URL.createObjectURL(new Blob([s], { type: "application/json" }));
        a.download = "qs_config.json";
        a.click();
      };
      q("#f").onchange = async (e) => {
        const t = await e.target.files[0].text();
        alert(await apiText("/api/set", { method: "POST", body: t }));
        load();
      };

      /* ---------- Tools ---------- */
      q("#btnTestIgn").onclick = () => apiText("/api/testcut?out=ign", { method: "POST" });
      q("#btnTestInj").onclick = () => apiText("/api/testcut?out=inj", { method: "POST" });
      q("#btnApplyTR").onclick = () => {
        const en = q("#tr_en").checked ? 1 : 0;
        const rpm = q("#tr_rpm").value;
        const ppr = q("#tr_ppr").value;
        return apiText(`/api/testrpm?en=${en}&rpm=${rpm}&ppr=${ppr}`, { method: "POST" });
      };
      q("#btnCalib").onclick = () => {
        const v = q("#cal_true").value;
        if (!v) return alert("Nhập RPM thực tế");
        return apiText(`/api/calib?true_rpm=${v}`, { method: "POST" }).then((t) => alert(t));
      };

      /* ---------- Logs ---------- */
      async function loadLogs() {
        try {
          const a = await apiGet("/api/log");
          if (!a) return;
          const out = a
            .map(
              (x) =>
                `[${x.t}] rpm=${x.rpm} cut=${x.cut}ms ${x.auto ? "AUTO" : "MAN"} ${
                  x.bf ? "BF" : ""
                } out=${x.out} why=${x.why}`
            )
            .join("\n");
          const pre = q("#logs");
          pre.textContent = out;
          pre.scrollTop = pre.scrollHeight;
        } catch (e) {}
      }
      q("#btnClearLog").onclick = () => apiText("/api/clearlog", { method: "POST" });

      /* ---------- Live RPM Gauge (8h → 3h, 0→14k) ---------- */
      let rpmSmooth = 0;
      const rpmAlpha = 0.35;
      /*
      const GA = {
        CX: 110,
        CY: 110,
        R: 90,
        START: 240, // 8 giờ
        END: 0, // 3 giờ
        // 
        */
  const GA = {
   CX: 120,
   CY: 120,
   R: 90,
   /* Gauge 8h → 3h như thiết kế bạn thích */
   START: 150,  // điểm bắt đầu cung (8 giờ = 240°)
   END: 0,     // điểm kết thúc cung (3 giờ = 90°)
   SWEEP: 0,    // tính ở configureGauge()
   LEN: 1,
   MAX: 14000,
   RED_FROM: 12000,
 };

/*
      function longSweep(start, end) {
        let s = ((end - start) % 360 + 360) % 360;
        if (s < 180) s += 360;
        return s;
      }
*/
function longSweep(start, end) {
  // cwShort = độ quét ngắn theo chiều kim đồng hồ (0..360)
  const cwShort = ((end - start) % 360 + 360) % 360;
  // long arc = 360 - cwShort (>=180)
  return cwShort < 180 ? 360 - cwShort : cwShort;
}

      function arcPath(cx, cy, r, sd, ed, forceLong = true) {
        const sr = (sd * Math.PI) / 180;
        const er = (ed * Math.PI) / 180;

        const x1 = cx + r * Math.cos(sr);
        const y1 = cy + r * Math.sin(sr);
        const x2 = cx + r * Math.cos(er);
        const y2 = cy + r * Math.sin(er);

        const laf = forceLong ? 1 : ((ed - sd + 360) % 360 > 180 ? 1 : 0);
        const swf = 1;

        return `M ${x1.toFixed(3)} ${y1.toFixed(3)} A ${r} ${r} 0 ${laf} ${swf} ${x2.toFixed(
          3
        )} ${y2.toFixed(3)}`;
      }

      function configureGauge({ start, end, max, redFrom = null }) {
        GA.START = start;
        GA.END = end;
        GA.MAX = max;
        GA.RED_FROM = redFrom;
        GA.SWEEP = longSweep(GA.START, GA.END);

        const track = q("#trackPath");
        const arc = q("#rpmArc");
        if (!track || !arc) return;

        const d = arcPath(GA.CX, GA.CY, GA.R, GA.START, GA.END, true);
        track.setAttribute("d", d);
        arc.setAttribute("d", d);

        GA.LEN = arc.getTotalLength ? arc.getTotalLength() : Math.PI * GA.R * (GA.SWEEP / 180);

        // ticks 2k
        const g = q("#rpmTicks");
        if (g) {
          g.innerHTML = "";
          const step = 2000;
          for (let v = 0; v <= GA.MAX; v += step) {
            const t = v / GA.MAX;
            const a = (GA.START + GA.SWEEP * t) % 360;


            const rad = (a * Math.PI) / 180;

            const x1 = GA.CX + Math.cos(rad) * (GA.R - 14);
            const y1 = GA.CY + Math.sin(rad) * (GA.R - 14);
            const x2 = GA.CX + Math.cos(rad) * GA.R;
            const y2 = GA.CY + Math.sin(rad) * GA.R;

            const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
            line.setAttribute("x1", x1);
            line.setAttribute("y1", y1);
            line.setAttribute("x2", x2);
            line.setAttribute("y2", y2);
            g.appendChild(line);

            const tx = GA.CX + Math.cos(rad) * (GA.R - 28);
            const ty = GA.CY + Math.sin(rad) * (GA.R - 28);
            const txt = document.createElementNS("http://www.w3.org/2000/svg", "text");
            txt.setAttribute("x", tx);
            txt.setAttribute("y", ty);
            txt.setAttribute("fill", "#A6B3BD");
            txt.setAttribute("font-size", "10");
            txt.setAttribute("text-anchor", "middle");
            txt.setAttribute("dominant-baseline", "middle");
            txt.textContent = v / 1000 + "k";
            g.appendChild(txt);
          }
        }

      // ---- redline overlay (đừng để trùng khối này) ----

/*
if (redFrom != null && redFrom < GA.MAX) {
  // vị trí bắt đầu vùng đỏ theo cấu hình cung hiện tại
  const a1 = (GA.START + GA.SWEEP * (redFrom / GA.MAX)) % 360;
  // vẽ từ a1 -> GA.END theo cung dài
  red.setAttribute("d", arcPath(GA.CX, GA.CY, GA.R, a1, GA.END, true));
  red.style.display = "";
} else {
  red.style.display = "none";
}*/
      }

/*
      function setGauge(rpm) {
        rpmSmooth = rpmSmooth ? rpmSmooth * (1 - rpmAlpha) + rpm * rpmAlpha : rpm;
        const v = Math.max(0, Math.min(GA.MAX, rpmSmooth));

        const txt = q("#rpmText");
        if (txt) txt.textContent = Math.round(v);

        const a = (GA.START + GA.SWEEP * (v / GA.MAX)) % 360;
        const needle = q("#rpmNeedle");
        if (needle) needle.setAttribute("transform", `translate(${GA.CX},${GA.CY}) rotate(${a})`);

        const arc = q("#rpmArc");
        if (arc) {
          const len = GA.LEN * (v / GA.MAX);
          arc.setAttribute("stroke-dasharray", `${len} ${Math.max(1, GA.LEN - len)}`);
          arc.setAttribute(
            "stroke",
            GA.RED_FROM != null && v >= GA.RED_FROM ? "#FF6B6B" : "#FF6B6B" : "#1E88FF"
          );
        }
      }
*/

function setGauge(rpm) {
  // khôi phục smoothing + clamp để tạo v
  rpmSmooth = rpmSmooth ? rpmSmooth * (1 - rpmAlpha) + rpm * rpmAlpha : rpm;
  const v = Math.max(0, Math.min(GA.MAX, rpmSmooth));
  const t = v / GA.MAX; // 0..1

  // kim: sử dụng cùng hệ quy chiếu với ticks/arc (240° → 90°)
  //const a = (GA.START + GA.SWEEP * t) % 360;
    const a = (240 + ((90 - 240 + 360) % 360) * t) % 360;
  q("#rpmNeedle").setAttribute("transform", `rotate(${a} ${GA.CX} ${GA.CY})`);

  // cập nhật arc theo t (giữ nguyên track/ticks)
  const arc = q("#rpmArc");
  if (arc) {
    const len = GA.LEN * t;
    arc.setAttribute("stroke-dasharray", `${len} ${Math.max(1, GA.LEN - len)}`);
    arc.setAttribute("stroke", GA.RED_FROM != null && v >= GA.RED_FROM ? "#FF6B6B" : "#1E88FF");
  }

  // cập nhật số RPM hiển thị
  const txt = q("#rpmText");    if (txt) txt.textContent = Math.round(v);
  const val = q("#rpmValue");   if (val) val.textContent = `${Math.round(v)} rpm`;
}


             async function pollRPM() {
         try {
           const r = await fetch("/api/rpm");
           if (!r.ok) return;
           const j = await r.json();
           if (typeof j.rpm === "number") {
             setGauge(j.rpm);
             // Cập nhật RPM status indicator
             const rpmStatusText = q("#rpmStatusText");
             if (rpmStatusText) rpmStatusText.textContent = j.rpm;
           }
         } catch (e) {}
       }

      
      /* ---------- Lock helpers ---------- */
      const only01 = (s)=> (s||"").replace(/[^01]/g,"").slice(0,8);
             async function lockState(){
         try{ 
           const r = await apiGet("/api/lock_state"); 
           if(!r) return;
           
           const lockStatus = r.locked ? "LOCKED" : "UNLOCKED";
           
           // Cập nhật Lock tab
           q("#lockStateText").textContent = lockStatus;
           
           // Cập nhật header status indicator
           const lockStatusText = q("#lockStatusText");
           if (lockStatusText) {
             lockStatusText.textContent = lockStatus;
             
             // Thay đổi màu theo trạng thái
             const lockStatusItem = q("#lockStatus");
             if (lockStatusItem) {
               lockStatusItem.style.borderColor = r.locked ? "var(--danger)" : "var(--success)";
               lockStatusText.style.color = r.locked ? "var(--danger)" : "var(--success)";
             }
           }
           
           // Cập nhật trạng thái Lock dựa trên config
           const lockEnabled = q("#lock_enabled")?.checked || false;
           if (lockEnabled && r.locked) {
             // Lock được bật và xe đang khóa → cắt IGN
             console.log("Lock enabled and vehicle is locked - cutting IGN");
           } else if (!lockEnabled) {
             // Lock không được bật → hoạt động bình thường
             console.log("Lock disabled - normal operation");
           }
           
         }catch(e){
           // Cập nhật status khi có lỗi
           const lockStatusText = q("#lockStatusText");
           if (lockStatusText) lockStatusText.textContent = "ERROR";
           console.error("Lock state error:", e);
         }
       }
      q("#btnLockRefresh")?.addEventListener("click", lockState);
             q("#btnLockSaveCfg")?.addEventListener("click", async ()=>{
         try {
           const body = {
             lock_enabled: q("#lock_enabled")?.checked || false,
             lock_cut_sel: q("#lock_cut_sel")?.value || "ign",
             lock_short_ms_max: +q("#lock_short_ms_max")?.value || 300,
             lock_long_ms_min:  +q("#lock_long_ms_min")?.value || 600,
             lock_gap_ms:       +q("#lock_gap_ms")?.value || 400,
             lock_timeout_s:    +q("#lock_timeout_s")?.value || 30,
             lock_max_retries:  +q("#lock_max_retries")?.value || 5
           };
           
           const result = await apiText("/api/set", {method:"POST", body: JSON.stringify(body)});
           
           // Hiển thị feedback thành công
           const msgLockCfg = q("#msgLockCfg");
           if (msgLockCfg) {
             msgLockCfg.textContent = "Lock config saved successfully!";
             msgLockCfg.style.color = "var(--success)";
             setTimeout(() => {
               msgLockCfg.textContent = "";
               msgLockCfg.style.color = "";
             }, 3000);
           }
           
           // Cập nhật lock state sau khi save
           setTimeout(() => lockState(), 500);
           
         } catch (e) {
           // Hiển thị feedback lỗi
           const msgLockCfg = q("#msgLockCfg");
           if (msgLockCfg) {
             msgLockCfg.textContent = "Error saving lock config: " + e.message;
             msgLockCfg.style.color = "var(--danger)";
             setTimeout(() => {
               msgLockCfg.textContent = "";
               msgLockCfg.style.color = "";
             }, 3000);
           }
         }
       });
             q("#btnLockNow")?.addEventListener("click", async ()=>{
         try {
           await apiText("/api/lock_cmd", {method:"POST", body: JSON.stringify({cmd:"lock"})});
           q("#msgLockPass").textContent = "Vehicle locked successfully!";
           q("#msgLockPass").style.color = "var(--success)";
           setTimeout(() => {
             q("#msgLockPass").textContent = "";
             q("#msgLockPass").style.color = "";
           }, 3000);
           lockState();
         } catch (e) {
           q("#msgLockPass").textContent = "Error locking vehicle: " + e.message;
           q("#msgLockPass").style.color = "var(--danger)";
           setTimeout(() => {
             q("#msgLockPass").textContent = "";
             q("#msgLockPass").style.color = "";
           }, 3000);
         }
       });
       
       q("#btnUnlockPass")?.addEventListener("click", async ()=>{
         try {
           const code = only01(q("#unlock_pass").value);
           if (!code){ 
             q("#msgLockPass").textContent="Please enter valid pass (0/1)"; 
             q("#msgLockPass").style.color = "var(--warning)";
             setTimeout(()=> q("#msgLockPass").textContent="", 3000); 
             return; 
           }
           
           const t = await apiText("/api/lock_cmd", {method:"POST", body: JSON.stringify({cmd:"unlock", pass: code})});
           
           if (t && t.includes("OK")) {
             q("#msgLockPass").textContent = "Unlock successful!";
             q("#msgLockPass").style.color = "var(--success)";
           } else {
             q("#msgLockPass").textContent = t || "Unlock failed";
             q("#msgLockPass").style.color = "var(--danger)";
           }
           
           setTimeout(()=> q("#msgLockPass").textContent="", 3000);
           lockState();
         } catch (e) {
           q("#msgLockPass").textContent = "Error during unlock: " + e.message;
           q("#msgLockPass").style.color = "var(--danger)";
           setTimeout(()=> q("#msgLockPass").textContent="", 3000);
         }
       });
      q("#btnLockSet")?.addEventListener("click", async ()=>{
        try {
          const np = only01(q("#new_pass").value);
          if (!np){ 
            q("#msgLockPass").textContent="Please enter new pass (0/1)"; 
            q("#msgLockPass").style.color = "var(--warning)";
            setTimeout(()=> q("#msgLockPass").textContent="", 3000); 
            return; 
          }
          
          const t = await apiText("/api/set", {method:"POST", body: JSON.stringify({lock_code: np})});
          
          if (t && t.includes("OK")) {
            q("#msgLockPass").textContent = "New pass set successfully!";
            q("#msgLockPass").style.color = "var(--success)";
          } else {
            q("#msgLockPass").textContent = t || "Failed to set pass";
            q("#msgLockPass").style.color = "var(--danger)";
          }
          
          setTimeout(()=> q("#msgLockPass").textContent="", 3000);
        } catch (e) {
          q("#msgLockPass").textContent = "Error setting pass: " + e.message;
          q("#msgLockPass").style.color = "var(--danger)";
          setTimeout(()=> q("#msgLockPass").textContent="", 3000);
        }
      });
      
      q("#btnLockChange")?.addEventListener("click", async ()=>{
        try {
          const op = only01(q("#old_pass").value);
          const np1 = only01(q("#new_pass").value);
          const np2 = only01(q("#new_pass2").value);
          
          if (!op || !np1 || np1!==np2){ 
            q("#msgLockPass").textContent="Please check all password fields"; 
            q("#msgLockPass").style.color = "var(--warning)";
            setTimeout(()=> q("#msgLockPass").textContent="", 3000); 
            return; 
          }
          
          const t = await apiText("/api/lock_change_pass", {method:"POST", body: JSON.stringify({old: op, neo: np1})});
          
          if (t && t.includes("OK")) {
            q("#msgLockPass").textContent = "Password changed successfully!";
            q("#msgLockPass").textContent = "Password changed successfully!";
            q("#msgLockPass").style.color = "var(--success)";
          } else {
            q("#msgLockPass").textContent = t || "Failed to change password";
            q("#msgLockPass").style.color = "var(--danger)";
          }
          
          setTimeout(()=> q("#msgLockPass").textContent="", 3000);
        } catch (e) {
          q("#msgLockPass").textContent = "Error changing password: " + e.message;
          q("#msgLockPass").style.color = "var(--danger)";
          setTimeout(()=> q("#msgLockPass").textContent="", 3000);
        }
      });

      // ---------- OTA Functions ----------
      async function uploadFirmware(file) {
        try {
          const formData = new FormData();
          formData.append('update', file);
          
          q("#fwProgress").style.display = "block";
          q("#fwStatus").textContent = "Uploading...";
          
          const response = await fetch('/api/ota/firmware', {
            method: 'POST',
            body: formData
          });
          
          if (response.ok) {
            const result = await response.json();
            q("#fwStatus").textContent = result.msg || "Upload successful!";
            setTimeout(() => {
              alert("Firmware uploaded successfully! Device will restart.");
              window.location.reload();
            }, 1000);
          } else {
            q("#fwStatus").textContent = "Upload failed!";
          }
        } catch (e) {
          q("#fwStatus").textContent = "Error: " + e.message;
        }
      }

      async function uploadFS(file) {
        try {
          const formData = new FormData();
          formData.append('update', file);
          
          q("#fsProgress").style.display = "block";
          q("#fsStatus").textContent = "Uploading...";
          
          const response = await fetch('/api/ota/fsimage', {
            method: 'POST',
            body: formData
          });
          
          if (response.ok) {
            const result = await response.json();
            q("#fsStatus").textContent = result.msg || "FS upload successful!";
            setTimeout(() => {
              alert("Filesystem updated successfully! Device will restart.");
              window.location.reload();
            }, 1000);
          } else {
            q("#fsStatus").textContent = "Upload failed!";
          }
        } catch (e) {
          q("#fsStatus").textContent = "Error: " + e.message;
        }
      }

      async function uploadSingleFile(file, path) {
        try {
          const formData = new FormData();
          formData.append('file', file);
          
          q("#singleStatus").textContent = "Uploading...";
          
          const response = await fetch(`/api/upload?path=${encodeURIComponent(path)}`, {
            method: 'POST',
            body: formData
          });
          
          if (response.ok) {
            const result = await response.json();
            q("#singleStatus").textContent = result.ok ? "Upload successful!" : "Upload failed!";
          } else {
            q("#singleStatus").textContent = "Upload failed!";
          }
        } catch (e) {
          q("#singleStatus").textContent = "Error: " + e.message;
        }
      }

      async function getOtaState() {
        try {
          const response = await fetch('/api/ota/state');
          if (response.ok) {
            const state = await response.json();
            q("#otaStatus").textContent = `Current: ${state.current}, Pending: ${state.pending}`;
          }
        } catch (e) {
          q("#otaStatus").textContent = "Error checking status";
        }
      }

      async function createBackup() {
        try {
          q("#otaStatus").textContent = "Creating backup...";
          const response = await fetch('/api/ota/backup_fs', { method: 'POST' });
          if (response.ok) {
            q("#otaStatus").textContent = "Backup created successfully!";
          } else {
            q("#otaStatus").textContent = "Backup failed!";
          }
        } catch (e) {
          q("#otaStatus").textContent = "Error: " + e.message;
        }
      }

      async function rollbackFs() {
        if (confirm("Rollback filesystem? This will restore the previous version.")) {
          try {
            q("#otaStatus").textContent = "Rolling back...";
            const response = await fetch('/api/ota/rollback_fs', { method: 'POST' });
            if (response.ok) {
              q("#otaStatus").textContent = "Rollback successful! Device will restart.";
              setTimeout(() => window.location.reload(), 2000);
            } else {
              q("#otaStatus").textContent = "Rollback failed!";
            }
          } catch (e) {
            q("#otaStatus").textContent = "Error: " + e.message;
          }
        }
      }

      async function rollbackFw() {
        if (confirm("Rollback firmware? This will restore the previous version.")) {
          try {
            q("#otaStatus").textContent = "Rolling back...";
            const response = await fetch('/api/ota/rollback_fw', { method: 'POST' });
            if (response.ok) {
              q("#otaStatus").textContent = "Rollback successful! Device will restart.";
              setTimeout(() => window.location.reload(), 2000);
            } else {
              q("#otaStatus").textContent = "Rollback failed!";
            }
          } catch (e) {
            q("#otaStatus").textContent = "Error: " + e.message;
          }
        }
      }

      // ---------- Event Listeners ----------
      q("#btnUploadFw")?.addEventListener("click", () => {
        const file = q("#firmwareFile").files[0];
        if (file) uploadFirmware(file);
        else alert("Please select a firmware file");
      });

      q("#btnUploadFs")?.addEventListener("click", () => {
        const file = q("#fsFile").files[0];
        if (file) uploadFS(file);
        else alert("Please select a filesystem image");
      });

      q("#btnUploadSingle")?.addEventListener("click", () => {
        const file = q("#singleFile").files[0];
        const path = q("#filePath").value;
        if (file && path) uploadSingleFile(file, path);
        else alert("Please select a file and specify path");
      });

             // WiFi Save button
       q("#btnWifiSave")?.addEventListener("click", saveWifiConfig);
       
       q("#btnOtaState")?.addEventListener("click", getOtaState);
       q("#btnBackupFs")?.addEventListener("click", createBackup);
       q("#btnRollbackFs")?.addEventListener("click", rollbackFs);
       q("#btnRollbackFw")?.addEventListener("click", rollbackFw);

             // ---------- Init ----------
       (async () => {
         setTab("qs");
         
         // Khởi tạo status indicators
         updateWifiStatus("Connecting...");
         q("#lockStatusText").textContent = "Unknown";
         q("#rpmStatusText").textContent = "0";
         
         await hold();
         await load();
         setInterval(loadLogs, 1000); // logs
         lockState();
         
         // Refresh status định kỳ
         setInterval(refreshWifiStatus, 5000); // WiFi status mỗi 5s
       })();

      // Gauge config + polling (8h → 3h: 240° → 90°)
      configureGauge({ start: GA.START, end: GA.END, max: 14000, redFrom: 12000 });
      rpmSmooth = 0;
      setGauge(0);                 // cho kim về 0 ngay (→ 240°)
      setInterval(pollRPM, 200);   // rồi mới poll


    </script>
  </body>
</html>