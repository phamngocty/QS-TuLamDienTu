<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1"
    />
    <title>ESP32-C3 Quickshifter</title>

    <style>
      :root {
        --bg: #0b0f10;
        --card: #11161a;
        --muted: #2a3238;
        --text: #e8eef2;
        --sub: #a6b3bd;
        --accent: #f3c316;
        --primary: #1e88ff;
        --danger: #ff4d4d;
        --ok: #18c37e;
        --br: 14px;
        --pad: 12px;
        --gap: 10px;
        --shadow: 0 6px 16px rgba(0, 0, 0, 0.35);
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        background: linear-gradient(180deg, #0b0f10, #0e1418);
        color: var(--text);
        font-family: system-ui, Segoe UI, Roboto, Arial, sans-serif;
      }
      header {
        position: sticky;
        top: 0;
        z-index: 5;
        background: linear-gradient(90deg, #0b0f10, #0e1418);
        padding: 14px 16px;
        display: flex;
        align-items: center;
        gap: 10px;
        border-bottom: 1px solid #182127;
        box-shadow: var(--shadow);
      }
      header .dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: var(--accent);
        box-shadow: 0 0 12px var(--accent);
      }
      header h1 {
        font-size: 18px;
        margin: 0;
        font-weight: 700;
        letter-spacing: 0.3px;
      }
      header .sp {
        flex: 1;
      }
      header .btn-danger {
        background: var(--danger);
        border: none;
        color: #fff;
        padding: 8px 12px;
        border-radius: 10px;
        cursor: pointer;
      }
      main {
        padding: 16px;
        display: grid;
        gap: var(--gap);
        grid-template-columns: 1fr;
      }
      .card {
        background: var(--card);
        border: 1px solid #1b242b;
        border-radius: var(--br);
        padding: var(--pad);
        box-shadow: var(--shadow);
      }
      .tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 8px;
      }
      .tab-btn {
        border: 1px solid #22303a;
        background: #0f151a;
        color: var(--text);
        padding: 8px 12px;
        border-radius: 10px;
        cursor: pointer;
      }
      .tab-btn.active {
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(30, 136, 255, 0.25);
      }
      .row {
        display: grid;
        gap: var(--gap);
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }
      
      /* Progress Bar Styles */
      .progress-container {
        margin: 12px 0;
      }
      .progress-bar {
        width: 100%;
        height: 20px;
        background-color: var(--muted);
        border-radius: 10px;
        overflow: hidden;
        border: 1px solid #1b242b;
      }
      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--ok), #18c37e);
        transition: width 0.3s ease;
        border-radius: 10px;
      }
      .progress-text {
        text-align: center;
        font-size: 12px;
        color: var(--sub);
        margin-top: 4px;
      }
      label {
        display: flex;
        flex-direction: column;
        gap: 6px;
        font-size: 13px;
        color: var(--sub);
      }
      input,
      select {
        background: #0f151a;
        color: #fff;
        border: 1px solid #24323b;
        border-radius: 10px;
        padding: 8px 10px;
        outline: none;
      }
      input:focus,
      select:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(30, 136, 255, 0.25);
      }
      .btn {
        border: 1px solid #22303a;
        background: #121a1f;
        color: var(--text);
        padding: 8px 12px;
        border-radius: 10px;
        cursor: pointer;
      }
      .btn.primary {
        border-color: var(--primary);
        background: #0f1720;
      }
      .btn.accent {
        border-color: #f3c316;
        background: #17160a;
      }
      .btn.ok {
        border-color: #18c37e;
        background: #0f1915;
      }
      .btn.danger {
        border-color: #ff4d4d;
        background: #1c1010;
      }
      .table {
        overflow: auto;
        border-radius: 12px;
        border: 1px solid #22303a;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }
      th,
      td {
        padding: 8px 10px;
        border-bottom: 1px solid #1e2a32;
        text-align: left;
      }
      pre {
        white-space: pre-wrap;
        background: #0a0f12;
        border: 1px solid #1b242b;
        border-radius: 12px;
        padding: 10px;
        max-height: 260px;
        overflow: auto;
      }
      .muted {
        color: var(--sub);
      }
      
      span {
        display: inline-block;
      }
      
      h3 {
        margin: 0 0 12px 0;
        font-size: 16px;
        font-weight: 600;
        color: var(--text);
      }
      
      button {
        border: 1px solid #22303a;
        background: #121a1f;
        color: var(--text);
        padding: 8px 12px;
        border-radius: 10px;
        cursor: pointer;
        font-size: 13px;
        transition: all 0.2s ease;
      }
      
      button:hover {
        background: #1a252a;
        border-color: #2a3a42;
      }
      
      #wifi {
        display: none;
      }
      .msg {
        background: #18c37e;
        color: #fff;
        padding: 10px;
        border-radius: 8px;
        margin: 10px 0;
        display: none;
      }
      @media (min-width: 900px) {
        main {
          grid-template-columns: 1fr 1fr;
        }
      }
    </style>
  </head>

  <body>
    <!-- ====================== HEADER ====================== -->
    <header>
      <div class="dot"></div>
      <h1>Tự làm điện tử — Quickshifter</h1>
      <div class="sp"></div>
      <button id="btnWifiOff" class="btn-danger">Tắt Wi-Fi</button>
    </header>
    
    <!-- ======================= BODY ======================= -->
    <main>
      <div class="card">
        <!-- -------- Tabs -------- -->
        <div class="tabs">
          <button id="t_qs" class="tab-btn active">Quickshifter</button>
          <button id="t_bf" class="tab-btn">Backfire</button>
          <button id="t_tools" class="tab-btn">Tools & Logs</button>
          <button id="t_lock" class="tab-btn">Lock</button>
          <button id="t_wifi" class="tab-btn">Wi-Fi</button>
        </div>

        <!-- ========== TAB: QUICKSHIFTER ========== -->
        <section id="qs">
          <!-- Controls -->
          <div class="row">
            <label>
              Mode
              <select id="mode">
                <option value="0">Manual</option>
                <option value="1">Auto</option>
              </select>
            </label>

            <label>
              Cut Output
              <select id="cutout">
                <option value="0">Ignition</option>
                <option value="1">Injector</option>
              </select>
            </label>

            <label>
              RPM Source
              <select id="rsrc">
                <option value="0">Coil</option>
                <option value="1">Injector</option>
              </select>
            </label>

            <label>
              PPR
              <select id="ppr">
                <option>0.5</option>
                <option selected>1</option>
                <option>2</option>
              </select>
            </label>

            <label>RPM min <input id="rpmmin" type="number" value="2500" /></label>
            <label>Manual kill (ms) <input id="mkill" type="number" value="70" /></label>
            <label>Debounce shift (ms) <input id="deb" type="number" value="15" /></label>
            <label>Hold-off (ms) <input id="hold" type="number" value="200" /></label>
          </div>

          <!-- Live RPM Gauge -->
          <div id="rpmCard" class="card" style="margin-top: 10px">
            <h3>Live RPM</h3>

            <div class="rpm-wrap" style="display: grid; place-items: center; padding: 10px">
  <svg
    id="rpmGauge"
    viewBox="0 0 240 240"
    width="100%"
    style="max-width: 420px"
  >
<!-- track (8h → 3h, cung dài 210°) -->
<path
  id="trackPath"
  fill="none"
  stroke="#24323B"
  stroke-width="16"
  stroke-linecap="round"
  d="M 42.060 165.000 A 90 90 0 1 1 210.000 120.000"
/>
<g id="rpmTicks" stroke="#2A3238"></g>

<!-- value arc (8h → 3h) -->
<path
  id="rpmArc"
  fill="none"
  stroke="#1E88FF"
  stroke-width="16"
  stroke-linecap="round"
  stroke-dasharray="0 999"
  d="M 42.060 165.000 A 90 90 0 1 1 210.000 120.000"
/>



    <!-- kim -->
    <line
      id="rpmNeedle"
      x1="120"
      y1="120"
      x2="120"
      y2="35"
      stroke="#FFEB3B"
      stroke-width="4"
      stroke-linecap="round"
      
          
    ></line>

    <!-- tâm kim -->
    <circle cx="120" cy="120" r="6" fill="#FFEB3B"></circle>

    <!-- nhãn RPM -->
    <text
      id="rpmValue"
      x="120"
      y="200"
      text-anchor="middle"
      fill="#fff"
      font-size="20"
      font-weight="bold"
    >0 rpm</text>
  </svg>
</div>


              <div style="margin-top: 6px; font-size: 28px; font-weight: 700">
                <span id="rpmText">0</span>
                <span style="font-size: 14px; color: #a6b3bd">rpm</span>
              </div>
            </div>
          </div>


          <!-- Auto Map -->
          <div class="card" style="margin-top: 10px">
            <h3>Auto Map</h3>
            <div class="table">
              <table>
                <thead>
                  <tr>
                    <th>Lo</th>
                    <th>Hi</th>
                    <th>Cut (ms)</th>
                  </tr>
                </thead>
                <tbody id="map"></tbody>
              </table>
            </div>

            <div style="display: flex; gap: 8px; margin-top: 8px">
              <button id="btnAddRow" class="btn accent">Thêm dòng</button>
              <button id="btnSave" class="btn ok">Lưu</button>
              <button id="btnLoad" class="btn">Tải</button>
            </div>
          </div>
        </section>

        <!-- ========== TAB: BACKFIRE ========== -->
        <section id="bf" style="display:none">
  <div class="row">
    <label><span>Enable</span><input id="bf_enable" type="checkbox" /></label>
    <label><span>IGN only</span><input id="bf_ign_only" type="checkbox" checked /></label>

    <label>Mode
      <div style="display:flex; gap:12px; align-items:center">
        <label><input id="bf_mode_shift"   type="checkbox" checked /> SHIFT</label>
        <label><input id="bf_mode_overrun" type="checkbox" checked /> OVERRUN</label>
      </div>
    </label>

    <label>RPM min <input id="bf_rpm_min" type="number" value="4500" /></label>
    <label>RPM max <input id="bf_rpm_max" type="number" value="9000" /></label>
    <label>Warmup (s) <input id="bf_warmup_s" type="number" value="120" /></label>

    <label>Decel threshold (rpm/s)
      <input id="bf_decel_thresh" type="number" value="3000" />
    </label>
    <label>Window after shift (ms)
      <input id="bf_window_ms" type="number" value="250" />
    </label>

    <label>Burst count <input id="bf_burst_count" type="number" value="3" /></label>
    <label>Burst ON (ms) <input id="bf_burst_on" type="number" value="25" /></label>
    <label>Burst OFF (ms) <input id="bf_burst_off" type="number" value="75" /></label>
    <label>Refractory (ms) <input id="bf_refractory_ms" type="number" value="1500" /></label>
  </div>

  <div style="margin-top:8px">
    <button id="btnSaveBF" class="btn ok">Lưu</button>
  </div>
</section>


        <!-- ========== TAB: TOOLS & LOGS ========== -->
        <section id="tools" style="display: none">
          <div class="row">
            <div class="card">
              <h3>Test Output</h3>
              <div style="display: flex; gap: 8px; flex-wrap: wrap">
                <button id="btnTestIgn" class="btn primary">Cắt IGN 50ms</button>
                <button id="btnTestInj" class="btn primary">Cắt INJ 50ms</button>
              </div>
            </div>

            <div class="card">
              <h3>Test RPM</h3>
              <div class="row">
                <label>Enable <input id="tr_en" type="checkbox" /></label>
                <label>RPM <input id="tr_rpm" type="number" value="5000" /></label>
                <label>
                  PPR
                  <select id="tr_ppr">
                    <option>0.5</option>
                    <option selected>1</option>
                    <option>2</option>
                  </select>
                </label>
              </div>

              <div style="margin-top: 8px">
                <button id="btnApplyTR" class="btn ok">Apply</button>
              </div>
            </div>

            <div class="card">
              <h3>Calibrate RPM</h3>
              <div class="row">
                <label>RPM thực tế <input id="cal_true" type="number" /></label>
              </div>

              <div style="margin-top: 8px">
                <button id="btnCalib" class="btn ok">Calibrate</button>
              </div>
            </div>

            <div class="card">
              <h3>Config</h3>
                              <div style="display: flex; gap: 8px; flex-wrap: wrap">
                  <button id="btnExport" class="btn">Export JSON</button>
                  <input id="f" class="btn" type="file" accept=".json" />
                  <button id="btnReload" class="btn">Reload</button>
            </div>
          </div>

          <div class="card">
              <h3>Lock Configuration</h3>
              <div class="row">
                <label><span>Enable Lock khi cấp nguồn</span><input id="lock_enabled" type="checkbox" /></label>
                <label>Cut on lock
                  <select id="lock_cut_sel">
                    <option value="ign">Ignition</option>
                    <option value="inj">Injector</option>
                  </select>
                </label>
                <label>Short max (ms) <input id="lock_short_ms_max" type="number" value="300" /></label>
                <label>Long min (ms)  <input id="lock_long_ms_min"  type="number" value="600" /></label>
                <label>Gap (ms)       <input id="lock_gap_ms"       type="number" value="400" /></label>
                <label>Timeout (s)    <input id="lock_timeout_s"    type="number" value="30" /></label>
                <label>Max retries    <input id="lock_max_retries"  type="number" value="5" /></label>
              </div>
              <div style="margin-top:8px">
                <button id="btnLockSaveCfg" class="btn ok">Save Lock Config</button>
                <span id="msgLockCfg" class="muted"></span>
              </div>
            </div>

            <div class="card">
              <h3>OTA Update</h3>
              <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px">
                <button id="btnOtaPage" class="btn accent">Mở trang OTA dự phòng</button>
                <button id="btnOtaState" class="btn">OTA State</button>
              </div>
              
              <div style="margin-bottom: 12px">
                <h4 style="margin: 8px 0; color: #f3c316">Upload Firmware</h4>
                <form id="otaFwForm" enctype="multipart/form-data" style="display: flex; gap: 8px; align-items: center">
                  <input type="file" name="update" accept=".bin" required style="flex: 1">
                  <button type="submit" class="btn primary">Upload FW</button>
                </form>
                <div class="progress-container" style="display: none; margin-top: 8px">
                  <div class="progress-bar">
                    <div class="progress-fill" style="width: 0%"></div>
              </div>
                  <div class="progress-text">0% (0 KB / 0 KB) - 0 KB/s</div>
            </div>
                <div id="otaFwMsg" class="msg" style="display: none; margin-top: 8px"></div>
          </div>

              <div style="margin-bottom: 12px">
                <h4 style="margin: 8px 0; color: #f3c316">Upload FS Image</h4>
                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px">
                  <input type="checkbox" id="createBackup" checked>
                  <span>Create FS backup before flashing</span>
                </label>
                <form id="otaFsForm" enctype="multipart/form-data" style="display: flex; gap: 8px; align-items: center">
                  <input type="file" name="update" accept=".bin" required style="flex: 1">
                  <button type="submit" class="btn primary">Upload FS</button>
                </form>
                <div class="progress-container" style="display: none; margin-top: 8px">
                  <div class="progress-bar">
                    <div class="progress-fill" style="width: 0%"></div>
              </div>
                  <div class="progress-text">0% (0 KB / 0 KB) - 0 KB/s</div>
              </div>
                <div id="otaFsMsg" class="msg" style="display: none; margin-top: 8px"></div>
              </div>
              
              <div style="margin-bottom: 12px">
                <h4 style="margin: 8px 0; color: #f3c316">Upload Single File</h4>
                <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px">
                  <input type="text" id="upPath" value="/index.html" placeholder="Path" style="flex: 1">
                  <input type="file" name="file" id="oneFile" required>
              </div>
                <button id="btnUploadFile" class="btn primary">Upload File</button>
                <div class="progress-container" style="display: none; margin-top: 8px">
                  <div class="progress-bar">
                    <div class="progress-fill" style="width: 0%"></div>
                  </div>
                  <div class="progress-text">0% (0 KB / 0 KB) - 0 KB/s</div>
                </div>
                <div id="otaFileMsg" class="msg" style="display: none; margin-top: 8px"></div>
            </div>

              <hr style="margin: 16px 0">
              
              <div style="margin-bottom: 12px">
                <h4 style="margin: 8px 0; color: #f3c316">Backup & Restore</h4>
                <div style="display: flex; gap: 8px; flex-wrap: wrap">
                  <button id="btnCreateBackup" class="btn accent">Create FS Backup Now</button>
                  <button id="btnRollbackFs" class="btn warning">Rollback FS</button>
                  <button id="btnRollbackFw" class="btn danger">Rollback Firmware</button>
              </div>
              </div>
            </div>
          </div>

          <div class="card">
            <h3>Logs</h3>
            <pre id="logs" class="muted"></pre>
            <div>
              <button id="btnClearLog" class="btn danger">Clear</button>
            </div>
          </div>
        </section>

        <!-- ========== TAB: LOCK ========== -->
        <section id="lock" style="display: none">
            <div class="row">
            <div class="card">
              <h3>Trạng thái Lock</h3>
              <div class="row" style="align-items:center">
                <span class="muted">•</span>
                <span id="lockStateText" class="muted">Unknown</span>
                <button id="btnLockRefresh" class="btn" style="margin-left:auto">Refresh</button>
            </div>
              <div class="muted">
                <small>• <strong>LOCKED</strong>: Hệ thống bị khóa, quickshifter không hoạt động<br>
                • <strong>UNLOCKED</strong>: Hệ thống mở, quickshifter hoạt động bình thường<br>
                • Để unlock: nhập pass bằng NPN (short=0, long=1) hoặc dùng API</small>
            </div>
          </div>

          <div class="card">
              <h3>Đổi mật khẩu</h3>
              <div class="row" style="gap:10px">
                <input id="old_pass" placeholder="Current pass (0/1)" maxlength="8" />
                <input id="new_pass" placeholder="New pass (0/1)" maxlength="8" />
                <input id="new_pass2" placeholder="Repeat new pass" maxlength="8" />
            </div>
            <div class="row">
                <button id="btnLockChange" class="btn">Change Pass</button>
                <span id="msgLockPass" class="muted"></span>
            </div>
              <div class="muted">
                <small>• Pass chỉ gồm 0 và 1 (ví dụ: 1001)<br>
                • Short pulse = 0, Long pulse = 1<br>
                • Đổi pass chỉ khi đã unlock</small>
            </div>
            </div>
          </div>
        </section>

          <!-- ========== TAB: WI-FI ========== -->
        <section id="wifi" style="display: none">
          <div class="row">
            <div class="card">
              <h3>Wi-Fi AP Status</h3>
              <div class="row">
                <label>SSID: <span id="wifi_ssid" class="muted">Loading...</span></label>
                <label>Status: <span id="wifi_status" class="muted">Loading...</span></label>
                <label>Timeout: <span id="wifi_timeout" class="muted">Loading...</span></label>
              </div>
              <div class="row">
                <button id="btnWifiRefresh" class="btn">Refresh Status</button>
                <button id="btnWifiOffTab" class="btn danger">Tắt Wi-Fi AP</button>
              </div>
            </div>

            <div class="card">
              <h3>Wi-Fi AP Configuration</h3>
              <div class="row">
                <label>SSID <input id="wifi_ssid_input" type="text" placeholder="Auto-generated from MAC" maxlength="31" readonly /></label>
                <label>Password <input id="wifi_pass_input" type="password" placeholder="12345678" maxlength="63" /></label>
                <label>Timeout (s) <input id="wifi_timeout_input" type="number" value="120" min="0" max="3600" /></label>
              </div>
              <div class="row">
                <button id="btnWifiSave" class="btn ok">Save & Apply</button>
                <span id="msgWifiConfig" class="muted"></span>
              </div>
              </div>
            </div>
          </section>

        </div>
      </main>

    <!-- ===================== SCRIPTS ===================== -->
    <script>
      /* ---------- Helpers + Tabs ---------- */
      const q = (s) => document.querySelector(s);
      const qa = (s) => [...document.querySelectorAll(s)];

      // Toast notification function
      function toast(success, message) {
        const toast = document.createElement('div');
        toast.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          padding: 12px 16px;
          border-radius: 8px;
          color: white;
          font-weight: 500;
          z-index: 1000;
          background: ${success ? 'var(--ok)' : 'var(--danger)'};
          box-shadow: var(--shadow);
          transition: all 0.3s ease;
        `;
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
          toast.style.opacity = '0';
          toast.style.transform = 'translateX(100%)';
          setTimeout(() => document.body.removeChild(toast), 300);
        }, 3000);
      }

      const tabs = { qs: q("#qs"), bf: q("#bf"), tools: q("#tools"), lock: q("#lock"), wifi: q("#wifi") };
      const tb = { qs: q("#t_qs"), bf: q("#t_bf"), tools: q("#t_tools"), lock: q("#t_lock"), wifi: q("#t_wifi") };

      function setTab(id) {
        for (const k in tabs) {
          tabs[k].style.display = k === id ? "block" : "none";
          tb[k].classList.toggle("active", k === id);
        }
      }
      // Tab event handlers will be set in init function

      async function apiGet(p) {
        const r = await fetch(p);
          return r.ok ? r.json() : null;
      }
      async function apiText(p, o) {
        const r = await fetch(p, o);
          return r.text();
      }

      async function hold() {
        try {
          await apiText("/api/wifi_hold?on=1", { method: "POST" });
      // Lock tab hookup - removed duplicate, using onclick above
        } catch (e) {}
      }
      async function wifiOff() {
          if (confirm("Tắt Wi-Fi AP ngay?")) {
            await apiText("/api/wifi_off", { method: "POST" });
          }
      }
      q("#btnWifiOff").onclick = wifiOff;

      /* ---------- Config load/save ---------- */
      let cfg = {};

      function renderCfg() {
        try {
          // Core quickshifter config
          if (q("#mode")) q("#mode").value = cfg.mode;
          if (q("#cutout")) q("#cutout").value = cfg.cut_output;
          if (q("#rsrc")) q("#rsrc").value = cfg.rpm_source;
          if (q("#ppr")) q("#ppr").value = cfg.ppr;
          if (q("#rpmmin")) q("#rpmmin").value = cfg.rpm_min;
          if (q("#mkill")) q("#mkill").value = cfg.manual_kill_ms;
          if (q("#deb")) q("#deb").value = cfg.debounce_shift_ms;
          if (q("#hold")) q("#hold").value = cfg.holdoff_ms;

          // Backfire config - with safety checks
          if (q("#bf_enable")) q("#bf_enable").checked = !!cfg.bf_enable;
          if (q("#bf_ign_only")) q("#bf_ign_only").checked = cfg.bf_ign_only ?? true;

          if (q("#bf_mode_shift")) q("#bf_mode_shift").checked = (cfg.bf_mode ?? 3) & 0x01;
          if (q("#bf_mode_overrun")) q("#bf_mode_overrun").checked = (cfg.bf_mode ?? 3) & 0x02;

          if (q("#bf_rpm_min")) q("#bf_rpm_min").value = cfg.bf_rpm_min ?? 4500;
          if (q("#bf_rpm_max")) q("#bf_rpm_max").value = cfg.bf_rpm_max ?? 9000;
          if (q("#bf_warmup_s")) q("#bf_warmup_s").value = cfg.bf_warmup_s ?? 120;

          if (q("#bf_decel_thresh")) q("#bf_decel_thresh").value = cfg.bf_decel_thresh ?? 3000;
          if (q("#bf_window_ms")) q("#bf_window_ms").value = cfg.bf_window_ms ?? 250;

          if (q("#bf_burst_count")) q("#bf_burst_count").value = cfg.bf_burst_count ?? 3;
          if (q("#bf_burst_on")) q("#bf_burst_on").value = cfg.bf_burst_on ?? 25;
          if (q("#bf_burst_off")) q("#bf_burst_off").value = cfg.bf_burst_off ?? 75;
          if (q("#bf_refractory_ms")) q("#bf_refractory_ms").value = cfg.bf_refractory_ms ?? 1500;

          // Auto Map table - with safety check
          const tbody = q("#map");
          if (tbody) {
            tbody.innerHTML = "";
            (cfg.map || []).forEach((b) => {
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td><input type="number" value="${b.lo}"></td>
                <td><input type="number" value="${b.hi}"></td>
                <td><input type="number" value="${b.t}"></td>`;
              tbody.appendChild(tr);
            });
          }
        } catch (e) {
          console.error("renderCfg error", e);
          toast(false, "UI render error: " + e.message);
        }
      }

      function collectCfg() {
        // Core config - with safety checks
        cfg.mode = q("#mode") ? +q("#mode").value : cfg.mode;
        cfg.cut_output = q("#cutout") ? +q("#cutout").value : cfg.cut_output;
        cfg.rpm_source = q("#rsrc") ? +q("#rsrc").value : cfg.rpm_source;
        cfg.ppr = q("#ppr") ? parseFloat(q("#ppr").value) : cfg.ppr;
        cfg.rpm_min = q("#rpmmin") ? +q("#rpmmin").value : cfg.rpm_min;
        cfg.manual_kill_ms = q("#mkill") ? +q("#mkill").value : cfg.manual_kill_ms;
        cfg.debounce_shift_ms = q("#deb") ? +q("#deb").value : cfg.debounce_shift_ms;
        cfg.holdoff_ms = q("#hold") ? +q("#hold").value : cfg.holdoff_ms;

        // Backfire config - with safety checks
        let mode = 0;
        if (q("#bf_mode_shift")?.checked)   mode |= 0x01;   // BF_SHIFT
        if (q("#bf_mode_overrun")?.checked) mode |= 0x02;   // BF_OVERRUN

        cfg.bf_enable        = q("#bf_enable")?.checked ? 1 : 0;
        cfg.bf_ign_only      = q("#bf_ign_only")?.checked ? 1 : 0;
        cfg.bf_mode          = mode;

        cfg.bf_rpm_min       = +(q("#bf_rpm_min")?.value || 4500);
        cfg.bf_rpm_max       = +(q("#bf_rpm_max")?.value || 9000);
        cfg.bf_warmup_s      = +(q("#bf_warmup_s")?.value || 120);

        cfg.bf_decel_thresh  = +(q("#bf_decel_thresh")?.value || 3000);
        cfg.bf_window_ms     = +(q("#bf_window_ms")?.value || 250);

        cfg.bf_burst_count   = +(q("#bf_burst_count")?.value || 3);
        cfg.bf_burst_on      = +(q("#bf_burst_on")?.value || 25);
        cfg.bf_burst_off     = +(q("#bf_burst_off")?.value || 75);
        cfg.bf_refractory_ms = +(q("#bf_refractory_ms")?.value || 1500);
        q("#btnSaveBF").onclick = save;


        // Auto Map collection - with safety check
        cfg.map = [];
        const rows = document.querySelectorAll("#map tr");
        rows.forEach((tr) => {
          const t = tr.querySelectorAll("input");
          if (t.length >= 3) {
            cfg.map.push({ lo: +t[0].value, hi: +t[1].value, t: +t[2].value });
          }
        });
      }

      async function load() {
          const d = await apiGet("/api/get");
          if (d) {
            cfg = d;
            renderCfg();
          
          // Load lock configuration
          if (d.lock_enabled !== undefined) {
            q("#lock_enabled").checked = d.lock_enabled;
          }
          if (d.lock_cut_sel !== undefined) {
            q("#lock_cut_sel").value = d.lock_cut_sel;
          }
          if (d.lock_short_ms_max !== undefined) {
            q("#lock_short_ms_max").value = d.lock_short_ms_max;
          }
          if (d.lock_long_ms_min !== undefined) {
            q("#lock_long_ms_min").value = d.lock_long_ms_min;
          }
          if (d.lock_gap_ms !== undefined) {
            q("#lock_gap_ms").value = d.lock_gap_ms;
          }
          if (d.lock_timeout_s !== undefined) {
            q("#lock_timeout_s").value = d.lock_timeout_s;
          }
          if (d.lock_max_retries !== undefined) {
            q("#lock_max_retries").value = d.lock_max_retries;
          }
          
          // Load WiFi configuration
          loadWifiConfig();
        }
      }
      async function save() {
          collectCfg();
        alert(await apiText("/api/set", { method: "POST", body: JSON.stringify(cfg) }));
      }

      q("#btnAddRow").onclick = () => {
          const tr = document.createElement("tr");
        tr.innerHTML =
          '<td><input type="number"></td><td><input type="number"></td><td><input type="number"></td>';
        q("#map").appendChild(tr);
      };
      q("#btnSave").onclick = save;
      q("#btnLoad").onclick = load;
      q("#btnSaveBF").onclick = save;
      q("#btnReload").onclick = load;

      q("#btnExport").onclick = () => {
          const s = JSON.stringify(cfg, null, 2);
          const a = document.createElement("a");
          a.href = URL.createObjectURL(new Blob([s], { type: "application/json" }));
          a.download = "qs_config.json";
          a.click();
      };
      q("#f").onchange = async (e) => {
          const t = await e.target.files[0].text();
        alert(await apiText("/api/set", { method: "POST", body: t }));
        load();
      };

      /* ---------- Tools ---------- */
      q("#btnTestIgn").onclick = () => apiText("/api/testcut?out=ign", { method: "POST" });
      q("#btnTestInj").onclick = () => apiText("/api/testcut?out=inj", { method: "POST" });
      q("#btnApplyTR").onclick = () => {
        const en = q("#tr_en").checked ? 1 : 0;
        const rpm = q("#tr_rpm").value;
        const ppr = q("#tr_ppr").value;
          return apiText(`/api/testrpm?en=${en}&rpm=${rpm}&ppr=${ppr}`, { method: "POST" });
      };
      q("#btnCalib").onclick = () => {
        const v = q("#cal_true").value;
        if (!v) return alert("Nhập RPM thực tế");
        return apiText(`/api/calib?true_rpm=${v}`, { method: "POST" }).then((t) => alert(t));
      };

      /* ---------- Logs ---------- */
      async function loadLogs() {
        try {
          const a = await apiGet("/api/log");
          if (!a) return;
          const out = a
            .map(
              (x) =>
                `[${x.t}] rpm=${x.rpm} cut=${x.cut}ms ${x.auto ? "AUTO" : "MAN"} ${
                  x.bf ? "BF" : ""
                } out=${x.out} why=${x.why}`
            )
            .join("\n");
          const pre = q("#logs");
            pre.textContent = out;
            pre.scrollTop = pre.scrollHeight;
        } catch (e) {}
      }
      q("#btnClearLog").onclick = () => apiText("/api/clearlog", { method: "POST" });

      /* ---------- OTA Update ---------- */
      function showOtaMsg(id, text, isError) {
        const msg = document.getElementById(id);
        msg.textContent = text;
        msg.style.background = isError ? '#ff4d4d' : '#18c37e';
        msg.style.display = 'block';
        setTimeout(() => msg.style.display = 'none', 5000);
      }

      // Mở trang OTA dự phòng
      q("#btnOtaPage").onclick = () => {
        location.href = '/ota';
      };

      // Form handlers removed - using addEventListener below

      /* ---------- Live RPM Gauge (8h → 3h, 0→14k) ---------- */
      let rpmSmooth = 0;
      const rpmAlpha = 0.35;
      // Gauge configuration removed - using active one below
 const GA = {
  CX: 120,
  CY: 120,
  R: 90,
  START: 150,   // 0 rpm ở vị trí 8 giờ
  END: 0,      // max rpm ở ~2 giờ
  SWEEP: 0,     // sẽ tính ở configureGauge
  LEN: 1,
  MAX: 14000,
  RED_FROM: 12000,
};

// Function moved below
function longSweep(start, end) {
  // cwShort = độ quét ngắn theo chiều kim đồng hồ (0..360)
  const cwShort = ((end - start) % 360 + 360) % 360;
  // long arc = 360 - cwShort (>=180)
  return cwShort < 180 ? 360 - cwShort : cwShort;
}

      function arcPath(cx, cy, r, sd, ed, forceLong = true) {
        const sr = (sd * Math.PI) / 180;
        const er = (ed * Math.PI) / 180;

        const x1 = cx + r * Math.cos(sr);
        const y1 = cy + r * Math.sin(sr);
        const x2 = cx + r * Math.cos(er);
        const y2 = cy + r * Math.sin(er);

        const laf = forceLong ? 1 : ((ed - sd + 360) % 360 > 180 ? 1 : 0);
        const swf = 1;

        return `M ${x1.toFixed(3)} ${y1.toFixed(3)} A ${r} ${r} 0 ${laf} ${swf} ${x2.toFixed(
          3
        )} ${y2.toFixed(3)}`;
      }

      function configureGauge({ start, end, max, redFrom = null }) {
          GA.START = start;
          GA.END = end;
          GA.MAX = max;
          GA.RED_FROM = redFrom;
          GA.SWEEP = longSweep(GA.START, GA.END);

        const track = q("#trackPath");
        const arc = q("#rpmArc");
          if (!track || !arc) return;

          const d = arcPath(GA.CX, GA.CY, GA.R, GA.START, GA.END, true);
          track.setAttribute("d", d);
          arc.setAttribute("d", d);

          GA.LEN = arc.getTotalLength ? arc.getTotalLength() : Math.PI * GA.R * (GA.SWEEP / 180);

          // ticks 2k
        const g = q("#rpmTicks");
          if (g) {
            g.innerHTML = "";
            const step = 2000;
            for (let v = 0; v <= GA.MAX; v += step) {
              const t = v / GA.MAX;
           // const a = (GA.START + GA.SWEEP * t) % 360;
              const a = (GA.START + GA.SWEEP * (v / GA.MAX)) % 360;
              
            
  q("#rpmNeedle").setAttribute("transform", `rotate(${a} ${GA.CX} ${GA.CY})`);


              const rad = (a * Math.PI) / 180;

              const x1 = GA.CX + Math.cos(rad) * (GA.R - 14);
              const y1 = GA.CY + Math.sin(rad) * (GA.R - 14);
              const x2 = GA.CX + Math.cos(rad) * GA.R;
              const y2 = GA.CY + Math.sin(rad) * GA.R;

              const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
              line.setAttribute("x1", x1);
              line.setAttribute("y1", y1);
              line.setAttribute("x2", x2);
              line.setAttribute("y2", y2);
              g.appendChild(line);

              const tx = GA.CX + Math.cos(rad) * (GA.R - 28);
              const ty = GA.CY + Math.sin(rad) * (GA.R - 28);
              const txt = document.createElementNS("http://www.w3.org/2000/svg", "text");
              txt.setAttribute("x", tx);
              txt.setAttribute("y", ty);
              txt.setAttribute("fill", "#A6B3BD");
              txt.setAttribute("font-size", "10");
              txt.setAttribute("text-anchor", "middle");
              txt.setAttribute("dominant-baseline", "middle");
              txt.textContent = v / 1000 + "k";
              g.appendChild(txt);
          }
        }

      // ---- redline overlay (đừng để trùng khối này) ----

/*
if (redFrom != null && redFrom < GA.MAX) {
  // vị trí bắt đầu vùng đỏ theo cấu hình cung hiện tại
  const a1 = (GA.START + GA.SWEEP * (redFrom / GA.MAX)) % 360;
  // vẽ từ a1 -> GA.END theo cung dài
  red.setAttribute("d", arcPath(GA.CX, GA.CY, GA.R, a1, GA.END, true));
  red.style.display = "";
} else {
  red.style.display = "none";
}*/
      }

// Function implementation cleaned up above

      function setGauge(rpm) {
        // khôi phục smoothing + clamp để tạo v
        rpmSmooth = rpmSmooth ? rpmSmooth * (1 - rpmAlpha) + rpm * rpmAlpha : rpm;
        const v = Math.max(0, Math.min(GA.MAX, rpmSmooth));
        const t = v / GA.MAX; // 0..1

        // kim: 240° -> 90° theo chiều kim đồng hồ, không đụng GA.START/END
        // sweepCW(240,90) = 210°
        const a = (240 + ((90 - 240 + 360) % 360) * t) % 360;
        q("#rpmNeedle").setAttribute("transform", `rotate(${a} ${GA.CX} ${GA.CY})`);

        // cập nhật arc theo t (giữ nguyên track/ticks)
        const arc = q("#rpmArc");
        if (arc) {
          const len = GA.LEN * t;
          arc.setAttribute("stroke-dasharray", `${len} ${Math.max(1, GA.LEN - len)}`);
          arc.setAttribute("stroke", GA.RED_FROM != null && v >= GA.RED_FROM ? "#FF6B6B" : "#1E88FF");
        }

        // cập nhật số RPM hiển thị
        const txt = q("#rpmText");    if (txt) txt.textContent = Math.round(v);
        const val = q("#rpmValue");   if (val) val.textContent = `${Math.round(v)} rpm`;
      }


      async function pollRPM() {
        try {
          const r = await fetch("/api/rpm");
          if (!r.ok) return;
          const j = await r.json();
          if (typeof j.rpm === "number") setGauge(j.rpm);
        } catch (e) {}
      }

      
      /* ---------- Lock helpers ---------- */
      const only01 = (s)=> (s||"").replace(/[^01]/g,"").slice(0,8);
      async function lockState(){
        try{ const r = await apiGet("/api/lock_state"); if(!r) return;
          q("#lockStateText").textContent = r.locked? "LOCKED":"UNLOCKED";
        }catch(e){}
      }
      q("#btnLockRefresh")?.addEventListener("click", lockState);
      // Event handler cho checkbox lock_enabled - CHỈ gọi config API, KHÔNG gọi lock command
      q("#lock_enabled")?.addEventListener("change", async (e) => {
        // Khi thay đổi checkbox, CHỈ cập nhật config, KHÔNG gọi lock command
          const body = {
          lock_enabled: e.target.checked
        };
        try {
          const result = await apiText("/api/set", {method:"POST", body: JSON.stringify(body)});
          if (result && result.includes("ok")) {
            // Hiển thị thông báo thành công
            q("#msgLockCfg").textContent = e.target.checked ? "Lock enabled" : "Lock disabled";
            q("#msgLockCfg").style.color = "#4CAF50";
          } else {
            throw new Error("Server error");
          }
        } catch (error) {
          q("#msgLockCfg").textContent = "Error: " + error;
          q("#msgLockCfg").style.color = "#f44336";
          // Revert checkbox state
          e.target.checked = !e.target.checked;
        }
        setTimeout(()=> q("#msgLockCfg").textContent="", 2000);
      });

      q("#btnLockSaveCfg")?.addEventListener("click", async ()=>{
        const body = {
          lock_enabled: q("#lock_enabled").checked,
          lock_cut_sel: q("#lock_cut_sel").value,
          lock_short_ms_max: +q("#lock_short_ms_max").value,
          lock_long_ms_min:  +q("#lock_long_ms_min").value,
          lock_gap_ms:       +q("#lock_gap_ms").value,
          lock_timeout_s:    +q("#lock_timeout_s").value,
          lock_max_retries:  +q("#lock_max_retries").value
        };
        q("#msgLockCfg").textContent = await apiText("/api/set", {method:"POST", body: JSON.stringify(body)});
        setTimeout(()=> q("#msgLockCfg").textContent="", 1200);
      });


      q("#btnLockChange")?.addEventListener("click", async ()=>{
        const op = only01(q("#old_pass").value);
        const np1 = only01(q("#new_pass").value);
        const np2 = only01(q("#new_pass2").value);
        if (!op || !np1 || np1!==np2){ q("#msgLockPass").textContent="Kiểm tra pass"; setTimeout(()=> q("#msgLockPass").textContent="", 1200); return; }
        const t = await apiText("/api/lock_change_pass", {method:"POST", body: JSON.stringify({old: op, neo: np1})});
        q("#msgLockPass").textContent = t || "Đổi OK";
        setTimeout(()=> q("#msgLockPass").textContent="", 1200);
      });

      // ---------- OTA Event Handlers ----------
      // OTA State
      q("#btnOtaState")?.addEventListener("click", async () => {
        try {
          const state = await apiGet("/api/ota/state");
          if (state) {
            alert(`OTA State:\nApp: ${state.app_label}\nPending: ${state.pending_validate}\nVersion: ${state.version}\nBackups: ${state.backup_list}`);
          }
        } catch (error) {
          console.error("OTA state error:", error);
        }
      });

      // Create Backup
      q("#btnCreateBackup")?.addEventListener("click", async () => {
        try {
          const result = await apiText("/api/ota/backup_fs", { method: "POST" });
          if (result && result.includes("ok")) {
            toast(true, "FS backup created successfully!");
          } else {
            toast(false, "Backup failed: " + result);
          }
        } catch (error) {
          console.error("Backup error:", error);
          toast(false, "Backup failed: " + error);
        }
      });

      // Rollback FS
      q("#btnRollbackFs")?.addEventListener("click", async () => {
        if (confirm("Rollback filesystem? This will reboot the device.")) {
          try {
            const result = await apiText("/api/ota/rollback_fs", { method: "POST" });
            if (result && result.includes("ok")) {
              toast(true, "FS rollback initiated, rebooting...");
            } else {
              toast(false, "Rollback failed: " + result);
            }
          } catch (error) {
            console.error("Rollback error:", error);
            toast(false, "Rollback failed: " + error);
          }
        }
      });

      // Rollback Firmware
      q("#btnRollbackFw")?.addEventListener("click", async () => {
        if (confirm("Rollback firmware? This will reboot the device.")) {
          try {
            const result = await apiText("/api/ota/rollback_fw", { method: "POST" });
            if (result && result.includes("ok")) {
              toast(true, "Firmware rollback initiated, rebooting...");
        } else {
              toast(false, "Rollback failed: " + result);
            }
        } catch (error) {
            console.error("Rollback error:", error);
            toast(false, "Rollback failed: " + error);
          }
        }
      });

      // Upload Single File
      q("#btnUploadFile")?.addEventListener("click", async () => {
        const fileInput = q("#oneFile");
        const pathInput = q("#upPath");
        
        if (!fileInput.files[0]) {
          alert("Please select a file");
          return;
        }
        
        const file = fileInput.files[0];
        const path = pathInput.value;
        
        if (!path) {
          alert("Please enter a path");
          return;
        }
        
        // Show progress
        const progressContainer = q("#oneFile").closest("div").nextElementSibling.nextElementSibling;
        const progressFill = progressContainer.querySelector(".progress-fill");
        const progressText = progressContainer.querySelector(".progress-text");
        
        progressContainer.style.display = "block";
        progressFill.style.width = "0%";
        progressText.textContent = "0% (0 KB / " + Math.round(file.size / 1024) + " KB) - 0 KB/s";
        
        // Hold AP
        await apiText("/api/wifi_hold?on=1", { method: "POST" });
        
        // Create FormData
        const formData = new FormData();
        formData.append("file", file);
        
        // Upload with progress
        const xhr = new XMLHttpRequest();
        xhr.open("POST", "/api/upload?path=" + encodeURIComponent(path));
        
        xhr.upload.onprogress = (e) => {
          if (e.lengthComputable) {
            const percent = Math.round((e.loaded / e.total) * 100);
            const loadedKB = Math.round(e.loaded / 1024);
            const totalKB = Math.round(e.total / 1024);
            const speed = Math.round(e.loaded / (Date.now() - startTime) * 1000 / 1024);
            
            progressFill.style.width = percent + "%";
            progressText.textContent = percent + "% (" + loadedKB + " KB / " + totalKB + " KB) - " + speed + " KB/s";
          }
        };
        
        xhr.onload = () => {
          if (xhr.status === 200) {
            try {
              const response = JSON.parse(xhr.responseText);
              if (response.ok) {
                toast(true, "File uploaded successfully!");
                progressContainer.style.display = "none";
                // Refresh page to show changes
                setTimeout(() => location.reload(), 1000);
              } else {
                toast(false, "Upload failed: " + (response.msg || "Unknown error"));
                progressContainer.style.display = "none";
              }
            } catch (e) {
              toast(false, "Upload failed: Invalid response");
              progressContainer.style.display = "none";
            }
          } else {
            toast(false, "Upload failed: " + xhr.responseText);
            progressContainer.style.display = "none";
          }
          
          // Release AP hold
          apiText("/api/wifi_hold?on=0", { method: "POST" });
        };
        
        xhr.onerror = () => {
          toast(false, "Upload failed");
          progressContainer.style.display = "none";
          apiText("/api/wifi_hold?on=0", { method: "POST" });
        };
        
        const startTime = Date.now();
        xhr.send(formData);
      });

      // FS Image Upload Form
      q("#otaFsForm")?.addEventListener("submit", async (e) => {
        e.preventDefault();
        
        const fileInput = e.target.querySelector('input[type="file"]');
        if (!fileInput.files[0]) {
          alert("Please select a filesystem image file");
          return;
        }
        
        const file = fileInput.files[0];
        const progressContainer = e.target.nextElementSibling;
        const progressFill = progressContainer.querySelector(".progress-fill");
        const progressText = progressContainer.querySelector(".progress-text");
        
        // Show progress
        progressContainer.style.display = "block";
        progressFill.style.width = "0%";
        progressText.textContent = "0% (0 KB / " + Math.round(file.size / 1024) + " KB) - 0 KB/s";
        
        // Hold AP
        await apiText("/api/wifi_hold?on=1", { method: "POST" });
        
        // Upload with progress
        const xhr = new XMLHttpRequest();
        xhr.open("POST", "/api/ota/fsimage");
        
        xhr.upload.onprogress = (e) => {
          if (e.lengthComputable) {
            const percent = Math.round((e.loaded / e.total) * 100);
            const loadedKB = Math.round(e.loaded / 1024);
            const totalKB = Math.round(e.total / 1024);
            const speed = Math.round(e.loaded / (Date.now() - startTime) * 1000 / 1024);
            
            progressFill.style.width = percent + "%";
            progressText.textContent = percent + "% (" + loadedKB + " KB / " + totalKB + " KB) - " + speed + " KB/s";
          }
        };
        
        xhr.onload = () => {
          if (xhr.status === 200) {
            try {
              const response = JSON.parse(xhr.responseText);
              if (response.ok) {
                toast(true, "Filesystem image uploaded successfully! Rebooting...");
                // Countdown and reload
                let countdown = 5;
                const countdownInterval = setInterval(() => {
                  countdown--;
                  if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    location.reload();
                  } else {
                    toast(true, `Rebooting in ${countdown} seconds...`);
                  }
                }, 1000);
              } else {
                toast(false, "Upload failed: " + (response.msg || "Unknown error"));
                progressContainer.style.display = "none";
              }
            } catch (e) {
              toast(false, "Upload failed: Invalid response");
              progressContainer.style.display = "none";
            }
          } else {
            toast(false, "Upload failed");
            progressContainer.style.display = "none";
          }
          
          // Release AP hold
          apiText("/api/wifi_hold?on=0", { method: "POST" });
        };
        
        xhr.onerror = () => {
          toast(false, "Upload failed");
          progressContainer.style.display = "none";
          apiText("/api/wifi_hold?on=0", { method: "POST" });
        };
        
        const formData = new FormData();
        formData.append("update", file);
        const startTime = Date.now();
        xhr.send(formData);
      });

      // Enhanced OTA Forms with Progress
      q("#otaFwForm")?.addEventListener("submit", async (e) => {
        e.preventDefault();
        
        const fileInput = e.target.querySelector('input[type="file"]');
        if (!fileInput.files[0]) {
          alert("Please select a firmware file");
          return;
        }
        
        const file = fileInput.files[0];
        const progressContainer = e.target.nextElementSibling;
        const progressFill = progressContainer.querySelector(".progress-fill");
        const progressText = progressContainer.querySelector(".progress-text");
        
        // Show progress
        progressContainer.style.display = "block";
        progressFill.style.width = "0%";
        progressText.textContent = "0% (0 KB / " + Math.round(file.size / 1024) + " KB) - 0 KB/s";
        
        // Hold AP
        await apiText("/api/wifi_hold?on=1", { method: "POST" });
        
        // Upload with progress
        const xhr = new XMLHttpRequest();
        xhr.open("POST", "/api/ota/firmware");
        
        xhr.upload.onprogress = (e) => {
          if (e.lengthComputable) {
            const percent = Math.round((e.loaded / e.total) * 100);
            const loadedKB = Math.round(e.loaded / 1024);
            const totalKB = Math.round(e.total / 1024);
            const speed = Math.round(e.loaded / (Date.now() - startTime) * 1000 / 1024);
            
            progressFill.style.width = percent + "%";
            progressText.textContent = percent + "% (" + loadedKB + " KB / " + totalKB + " KB) - " + speed + " KB/s";
          }
        };
        
        xhr.onload = () => {
          if (xhr.status === 200) {
            const response = JSON.parse(xhr.responseText);
            if (response.ok) {
              toast(true, "Firmware uploaded successfully! Rebooting...");
              // Countdown and reload
              let countdown = 5;
              const countdownInterval = setInterval(() => {
                countdown--;
                if (countdown <= 0) {
                  clearInterval(countdownInterval);
                  location.reload();
          } else {
                  toast(true, `Rebooting in ${countdown} seconds...`);
                }
              }, 1000);
            } else {
              toast(false, "Upload failed: " + response.msg);
              progressContainer.style.display = "none";
            }
          } else {
            toast(false, "Upload failed");
            progressContainer.style.display = "none";
          }
          
          // Release AP hold
          apiText("/api/wifi_hold?on=0", { method: "POST" });
        };
        
        xhr.onerror = () => {
          toast(false, "Upload failed");
          progressContainer.style.display = "none";
          apiText("/api/wifi_hold?on=0", { method: "POST" });
        };
        
        const formData = new FormData();
        formData.append("update", file);
        const startTime = Date.now();
        xhr.send(formData);
      });

      // ---------- WiFi Functions ----------
      // Refresh WiFi status
      async function wifiRefreshStatus() {
        try {
          const data = await apiGet("/api/wifi/status");
          if (data) {
            q("#wifi_ssid")?.textContent = data.ssid || "Unknown";
            q("#wifi_status")?.textContent = data.running ? "Running" : "Stopped";
            q("#wifi_timeout")?.textContent = (data.timeout_s || 0) + "s";
          }
        } catch (error) {
          console.error("Wi-Fi status error:", error);
          q("#wifi_ssid")?.textContent = "Error";
          q("#wifi_status")?.textContent = "Error";
          q("#wifi_timeout")?.textContent = "Error";
        }
      }

      // Load WiFi config vào form
      function loadWifiConfig() {
        try {
          if (cfg.ap_ssid !== undefined) {
            q("#wifi_ssid_input")?.value = cfg.ap_ssid || "";
            q("#wifi_pass_input")?.value = ""; // Không hiển thị password
            q("#wifi_timeout_input")?.value = cfg.ap_timeout_s || 120;
          } else {
            q("#wifi_ssid_input")?.value = "";
            q("#wifi_pass_input")?.value = "";
            q("#wifi_timeout_input")?.value = 120;
          }
        } catch (error) {
          console.error("Load Wi-Fi config error:", error);
          q("#wifi_ssid_input")?.value = "";
          q("#wifi_pass_input")?.value = "";
          q("#wifi_timeout_input")?.value = 120;
        }
      }

      // WiFi event listeners
      q("#btnWifiRefresh")?.addEventListener("click", wifiRefreshStatus);
      q("#btnWifiOffTab")?.addEventListener("click", wifiOff);
      q("#btnWifiSave")?.addEventListener("click", async () => {
        try {
          const pass = q("#wifi_pass_input")?.value || "";
          const timeout = +(q("#wifi_timeout_input")?.value || "120");
          
          const response = await fetch("/api/wifi/config", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ ap_pass: pass, ap_timeout_s: timeout })
          });
          
          if (response.ok) {
            toast(true, "Wi-Fi config updated");
            q("#msgWifiConfig").textContent = "Config updated successfully!";
            setTimeout(() => q("#msgWifiConfig").textContent = "", 3000);
            wifiRefreshStatus();
          } else {
            toast(false, "Failed to update Wi-Fi config");
          }
        } catch (error) {
          console.error("Wi-Fi save error:", error);
          toast(false, "Error saving Wi-Fi config");
        }
      });

      // ---------- Init ----------
      (async () => {
        setTab("qs");
        await hold();
        await load();
        setInterval(loadLogs, 1000); // logs
        lockState();
        
        // Load WiFi status
        wifiRefreshStatus();
        
        // Mark firmware as valid after successful boot
        setTimeout(async () => {
          try {
            await apiText("/api/ota/mark_valid", { method: "POST" });
            console.log("Firmware marked as valid");
          } catch (error) {
            console.log("Could not mark firmware as valid:", error);
          }
        }, 5000);
        
        // Gauge config + polling
        configureGauge({ start: GA.START, end: GA.END, max: 14000, redFrom: 12000 });
        rpmSmooth = 0;
        setGauge(0);                 // cho kim về 0 ngay (→ 240°)
        setInterval(pollRPM, 200);   // rồi mới poll
        
        // Setup tab event handlers AFTER DOM is ready
        console.log("Setting up tab handlers...");
        console.log("tb.qs element:", tb.qs);
        console.log("tabs.qs element:", tabs.qs);
        
        if (tb.qs) tb.qs.onclick = () => { console.log("QS clicked"); setTab("qs"); };
        if (tb.bf) tb.bf.onclick = () => { console.log("BF clicked"); setTab("bf"); };
        if (tb.tools) tb.tools.onclick = () => { console.log("Tools clicked"); setTab("tools"); };
        if (tb.lock) tb.lock.onclick = () => { console.log("Lock clicked"); setTab("lock"); };
        if (tb.wifi) tb.wifi.onclick = () => { console.log("WiFi clicked"); setTab("wifi"); };
        
        console.log("Tab handlers initialized");
      })();


    </script>
  </body>
</html>